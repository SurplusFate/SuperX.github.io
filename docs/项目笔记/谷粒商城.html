<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.53" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://SurplusFate.github.io/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html"><meta property="og:site_name" content="空~"><meta property="og:title" content="谷粒商城"><meta property="og:type" content="article"><meta property="og:updated_time" content="2022-12-06T08:01:15.000Z"><meta property="og:locale" content="zh-CN"><meta property="article:modified_time" content="2022-12-06T08:01:15.000Z"><link rel="icon" href="/logo.png"><script type="text/javascript" src="/base.js"></script><link rel="stylesheet" type="text/css" href="//at.alicdn.com/t/c/font_3721935_vu3qq5p7wsp.css"><title>谷粒商城 | 空~</title><meta name="description" content="学习记录">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style.212c1d4b.css" as="style" /><link rel="stylesheet" href="/assets/style.212c1d4b.css" />
    <link rel="modulepreload" href="/assets/app.03ab472a.js"><link rel="modulepreload" href="/assets/谷粒商城.html.ed1607fb.js"><link rel="modulepreload" href="/assets/_plugin-vue_export-helper.cdc0426e.js"><link rel="modulepreload" href="/assets/谷粒商城.html.4ce90c23.js"><link rel="prefetch" href="/assets/index.html.80e42b79.js" as="script" /><link rel="prefetch" href="/assets/index.html.282d080a.js" as="script" /><link rel="prefetch" href="/assets/1. VMware.html.2edc336e.js" as="script" /><link rel="prefetch" href="/assets/2. 文件管理.html.37a69cab.js" as="script" /><link rel="prefetch" href="/assets/3. 系统管理.html.33ab5912.js" as="script" /><link rel="prefetch" href="/assets/4. 用户和组.html.59cdd40a.js" as="script" /><link rel="prefetch" href="/assets/5. 软件包管理.html.f6a0d451.js" as="script" /><link rel="prefetch" href="/assets/6. JavaEE环境搭建.html.3aa39f75.js" as="script" /><link rel="prefetch" href="/assets/index.html.0b5fefd6.js" as="script" /><link rel="prefetch" href="/assets/1. Vue 核心.html.c44094e0.js" as="script" /><link rel="prefetch" href="/assets/2. 组件化编程.html.ae9b2474.js" as="script" /><link rel="prefetch" href="/assets/3. 脚手架.html.99ee1800.js" as="script" /><link rel="prefetch" href="/assets/index.html.087f61fc.js" as="script" /><link rel="prefetch" href="/assets/index.html.fd9faa9b.js" as="script" /><link rel="prefetch" href="/assets/@RestController 指定主路径无效踩坑.html.6616c0d2.js" as="script" /><link rel="prefetch" href="/assets/@XXmapping注解.html.f9adc0a8.js" as="script" /><link rel="prefetch" href="/assets/Cookie 存 JSON.html.aff20d72.js" as="script" /><link rel="prefetch" href="/assets/Filter 过滤器.html.2c4e4889.js" as="script" /><link rel="prefetch" href="/assets/SSM 环境搭建.html.1ca2f025.js" as="script" /><link rel="prefetch" href="/assets/TypeReference 获取泛型属性.html.bd40b590.js" as="script" /><link rel="prefetch" href="/assets/index.html.75ca7aaa.js" as="script" /><link rel="prefetch" href="/assets/resultType_int 返回值是 null.html.4c56b9d6.js" as="script" /><link rel="prefetch" href="/assets/sentinel 规则持久化.html.5963bb6b.js" as="script" /><link rel="prefetch" href="/assets/v-modeldisabled 和 disabled 踩坑.html.d6a5ddc0.js" as="script" /><link rel="prefetch" href="/assets/函数式编程.html.858dcfab.js" as="script" /><link rel="prefetch" href="/assets/原来 @Autowired 注解还可以这么玩？.html.4c73c2bb.js" as="script" /><link rel="prefetch" href="/assets/处理器方法的返回值.html.1aac030c.js" as="script" /><link rel="prefetch" href="/assets/请求转发与请求重定向.html.fc7b0cf5.js" as="script" /><link rel="prefetch" href="/assets/1.设计模式七大原则.html.f9bcc2f7.js" as="script" /><link rel="prefetch" href="/assets/2.创建型模式.html.d9a22853.js" as="script" /><link rel="prefetch" href="/assets/全局异常处理.html.bca1c06f.js" as="script" /><link rel="prefetch" href="/assets/分页查询.html.e4c96477.js" as="script" /><link rel="prefetch" href="/assets/用户中心.html.0564392e.js" as="script" /><link rel="prefetch" href="/assets/自定义消息转换器.html.7724099e.js" as="script" /><link rel="prefetch" href="/assets/自定义自动填充.html.05bac3ef.js" as="script" /><link rel="prefetch" href="/assets/1. Java语言概述与开发环境.html.6cabd079.js" as="script" /><link rel="prefetch" href="/assets/10. 面向对象（下）.html.59f7badf.js" as="script" /><link rel="prefetch" href="/assets/11. 与运行环境交互.html.33ff2522.js" as="script" /><link rel="prefetch" href="/assets/12. Java集合.html.ef6b76f0.js" as="script" /><link rel="prefetch" href="/assets/13. 泛型.html.4287d762.js" as="script" /><link rel="prefetch" href="/assets/14. 函数式编程.html.37825560.js" as="script" /><link rel="prefetch" href="/assets/15. 异常处理.html.7945d2f9.js" as="script" /><link rel="prefetch" href="/assets/16. 注解.html.a75fa186.js" as="script" /><link rel="prefetch" href="/assets/17. IO流.html.e3037b63.js" as="script" /><link rel="prefetch" href="/assets/18. 多线程.html.7d62534b.js" as="script" /><link rel="prefetch" href="/assets/19. 类加载机制与反射.html.e4650e71.js" as="script" /><link rel="prefetch" href="/assets/2. 第一个java程序.html.c0935996.js" as="script" /><link rel="prefetch" href="/assets/3. Java程序的基本规则.html.1ef47372.js" as="script" /><link rel="prefetch" href="/assets/4. 数据类型.html.ab0f2c9e.js" as="script" /><link rel="prefetch" href="/assets/5. 运算符.html.3304ab09.js" as="script" /><link rel="prefetch" href="/assets/6. 流程控制.html.d10b18bd.js" as="script" /><link rel="prefetch" href="/assets/7. 面向对象（上）.html.fea71c5b.js" as="script" /><link rel="prefetch" href="/assets/8. 数组.html.a99a8121.js" as="script" /><link rel="prefetch" href="/assets/9. 数组的常见算法.html.cdda16bf.js" as="script" /><link rel="prefetch" href="/assets/1. 创建与管理数据库.html.b9c6ee50.js" as="script" /><link rel="prefetch" href="/assets/2. 创建与管理数据表.html.110b42f9.js" as="script" /><link rel="prefetch" href="/assets/3. 约束管理.html.a26c1da8.js" as="script" /><link rel="prefetch" href="/assets/4. 数据表的基本操作.html.b472da07.js" as="script" /><link rel="prefetch" href="/assets/5. 视图.html.e6cdda1c.js" as="script" /><link rel="prefetch" href="/assets/6. 索引.html.32b05a9b.js" as="script" /><link rel="prefetch" href="/assets/7. 事务.html.0c5e5967.js" as="script" /><link rel="prefetch" href="/assets/1. 准备.html.1e5bd9bb.js" as="script" /><link rel="prefetch" href="/assets/10. 注解.html.2d47dc44.js" as="script" /><link rel="prefetch" href="/assets/11. 复杂查询环境搭建.html.b8ad0dc5.js" as="script" /><link rel="prefetch" href="/assets/12. 动态 SQL.html.ac7ad455.js" as="script" /><link rel="prefetch" href="/assets/13. MybatisPlus-基础篇.html.e013ac9a.js" as="script" /><link rel="prefetch" href="/assets/14. MybatisPlus-高级篇.html.10febe80.js" as="script" /><link rel="prefetch" href="/assets/2. 使用.html.385db588.js" as="script" /><link rel="prefetch" href="/assets/3. 主要类介绍.html.d8c04776.js" as="script" /><link rel="prefetch" href="/assets/4. 配置文件详解.html.9c0628f4.js" as="script" /><link rel="prefetch" href="/assets/5. CRUD.html.9b339a18.js" as="script" /><link rel="prefetch" href="/assets/6. 配置 environments.html.5d71d706.js" as="script" /><link rel="prefetch" href="/assets/7. ResultMap 结果集映射.html.b94a2c0c.js" as="script" /><link rel="prefetch" href="/assets/8. 日志.html.b29e7e70.js" as="script" /><link rel="prefetch" href="/assets/9. 分页.html.39151e9c.js" as="script" /><link rel="prefetch" href="/assets/index.html.3aed8e38.js" as="script" /><link rel="prefetch" href="/assets/0. Maven.html.8e74bd03.js" as="script" /><link rel="prefetch" href="/assets/1. HTML.html.fd0a1241.js" as="script" /><link rel="prefetch" href="/assets/10. JavaBean.html.9ad71281.js" as="script" /><link rel="prefetch" href="/assets/11. MVC 模式与三层架构的区别.html.50343c55.js" as="script" /><link rel="prefetch" href="/assets/12. Filter.html.287d0448.js" as="script" /><link rel="prefetch" href="/assets/13. 监听器.html.3670a1b2.js" as="script" /><link rel="prefetch" href="/assets/14. JDBC.html.806787fe.js" as="script" /><link rel="prefetch" href="/assets/15. Ajax.html.fd04da23.js" as="script" /><link rel="prefetch" href="/assets/2. CSS.html.388a266e.js" as="script" /><link rel="prefetch" href="/assets/3. JavaScript.html.ed63c41a.js" as="script" /><link rel="prefetch" href="/assets/4. jQuery.html.2df912ac.js" as="script" /><link rel="prefetch" href="/assets/5. xml 和 json.html.d8f4e0f8.js" as="script" /><link rel="prefetch" href="/assets/6. tomcat.html.9871e4d6.js" as="script" /><link rel="prefetch" href="/assets/7. Servlet.html.c5b0a3e8.js" as="script" /><link rel="prefetch" href="/assets/8. Cookie 和 Session.html.7b873ee8.js" as="script" /><link rel="prefetch" href="/assets/9. JSP.html.83323785.js" as="script" /><link rel="prefetch" href="/assets/1. Redis 常见命令.html.a5deffce.js" as="script" /><link rel="prefetch" href="/assets/2. Redis 的 Java 客户端.html.d7ccb9c3.js" as="script" /><link rel="prefetch" href="/assets/index.html.bc834456.js" as="script" /><link rel="prefetch" href="/assets/1. 短信登录.html.5bade4c8.js" as="script" /><link rel="prefetch" href="/assets/10. 用户签到.html.e438e3a8.js" as="script" /><link rel="prefetch" href="/assets/11. UV统计.html.204065e2.js" as="script" /><link rel="prefetch" href="/assets/2. 商户查询缓存.html.a9a903bb.js" as="script" /><link rel="prefetch" href="/assets/3. 优惠券秒杀.html.697d92b9.js" as="script" /><link rel="prefetch" href="/assets/4. 分布式锁.html.66a50eed.js" as="script" /><link rel="prefetch" href="/assets/5. 秒杀优化.html.bcdab385.js" as="script" /><link rel="prefetch" href="/assets/6. Redis 消息队列.html.afbad846.js" as="script" /><link rel="prefetch" href="/assets/7. 达人探店.html.68bd625f.js" as="script" /><link rel="prefetch" href="/assets/8. 好友关注.html.7e17cd57.js" as="script" /><link rel="prefetch" href="/assets/9. 附近商户.html.32c8ce93.js" as="script" /><link rel="prefetch" href="/assets/1. IOC.html.9c4fadf2.js" as="script" /><link rel="prefetch" href="/assets/10. 整合 Mybatis.html.14e6b6c3.js" as="script" /><link rel="prefetch" href="/assets/11. 事务.html.7b7f7366.js" as="script" /><link rel="prefetch" href="/assets/12.  web 项目中使用容器对象.html.2e65ea38.js" as="script" /><link rel="prefetch" href="/assets/2. Spring创建对象.html.8a5ccf7f.js" as="script" /><link rel="prefetch" href="/assets/3. DI 依赖注入.html.937373de.js" as="script" /><link rel="prefetch" href="/assets/4. Spring 配置.html.72d7495e.js" as="script" /><link rel="prefetch" href="/assets/5. Bean 自动装配.html.747ded3f.js" as="script" /><link rel="prefetch" href="/assets/6. 使用注解开发.html.c034ea17.js" as="script" /><link rel="prefetch" href="/assets/7. 使用 java 方式配置 Spring.html.5b6be305.js" as="script" /><link rel="prefetch" href="/assets/8. 代理模式.html.d84a7e15.js" as="script" /><link rel="prefetch" href="/assets/9. Spring AOP.html.cbb05fa0.js" as="script" /><link rel="prefetch" href="/assets/1. SpringBoot.html.57d1efde.js" as="script" /><link rel="prefetch" href="/assets/2. JavaConfig.html.1ee145c6.js" as="script" /><link rel="prefetch" href="/assets/3. Web组件.html.617537bd.js" as="script" /><link rel="prefetch" href="/assets/4. ORM 操作 MySQL.html.3378d7ec.js" as="script" /><link rel="prefetch" href="/assets/5. RESTful.html.4727682a.js" as="script" /><link rel="prefetch" href="/assets/6. 总结.html.7798d376.js" as="script" /><link rel="prefetch" href="/assets/index.html.f24698c0.js" as="script" /><link rel="prefetch" href="/assets/1. 认识微服务.html.2459315d.js" as="script" /><link rel="prefetch" href="/assets/10. 初识 Docker.html.41c5cbf4.js" as="script" /><link rel="prefetch" href="/assets/11. Centos 7 安装 Docker.html.1cf2990c.js" as="script" /><link rel="prefetch" href="/assets/12. Docker 基本操作.html.dc27cb8e.js" as="script" /><link rel="prefetch" href="/assets/13. Dockerfile 自定义镜像.html.980df827.js" as="script" /><link rel="prefetch" href="/assets/14. Docker-Compose.html.35a53dde.js" as="script" /><link rel="prefetch" href="/assets/15. Docker 镜像仓库.html.fc2ca0be.js" as="script" /><link rel="prefetch" href="/assets/16. 初识MQ.html.7d887d29.js" as="script" /><link rel="prefetch" href="/assets/17. RabbitMQ 安装.html.89520166.js" as="script" /><link rel="prefetch" href="/assets/18. MQ 快速入门.html.1b65915b.js" as="script" /><link rel="prefetch" href="/assets/19. SpringAMQP.html.c33c2beb.js" as="script" /><link rel="prefetch" href="/assets/2. 服务的远程调用.html.d4f7dfd9.js" as="script" /><link rel="prefetch" href="/assets/20. elasticsearch.html.02b1a095.js" as="script" /><link rel="prefetch" href="/assets/21. 安装 es、kibana.html.0bae21af.js" as="script" /><link rel="prefetch" href="/assets/22. 索引库操作.html.dc342fb1.js" as="script" /><link rel="prefetch" href="/assets/23. 文档操作.html.ebd11439.js" as="script" /><link rel="prefetch" href="/assets/24. RestAPI.html.e0c804ae.js" as="script" /><link rel="prefetch" href="/assets/25. RestClient 操作文档.html.ef4e0876.js" as="script" /><link rel="prefetch" href="/assets/26. DSL查询文档.html.31e4808f.js" as="script" /><link rel="prefetch" href="/assets/27. 搜索结果处理.html.23348339.js" as="script" /><link rel="prefetch" href="/assets/28. RestClient 查询文档.html.49235fd5.js" as="script" /><link rel="prefetch" href="/assets/29. 黑马旅游案例.html.0f1d41d3.js" as="script" /><link rel="prefetch" href="/assets/3. Eureka 注册中心.html.e0c56acf.js" as="script" /><link rel="prefetch" href="/assets/30. 数据聚合.html.abe0562e.js" as="script" /><link rel="prefetch" href="/assets/31. 自动补全.html.24728190.js" as="script" /><link rel="prefetch" href="/assets/32. 数据同步.html.1c66964f.js" as="script" /><link rel="prefetch" href="/assets/33. 集群.html.8528e8f9.js" as="script" /><link rel="prefetch" href="/assets/34. 微服务保护.html.8909761e.js" as="script" /><link rel="prefetch" href="/assets/4. Ribbon 负载均衡.html.e9678323.js" as="script" /><link rel="prefetch" href="/assets/5. Nacos 注册中心.html.70cbf4b5.js" as="script" /><link rel="prefetch" href="/assets/6. Nacos 配置管理.html.a0e64c58.js" as="script" /><link rel="prefetch" href="/assets/7. Nacos 集群搭建.html.2f20cb72.js" as="script" /><link rel="prefetch" href="/assets/8. Feign 远程调用.html.11090ec7.js" as="script" /><link rel="prefetch" href="/assets/9. Gateway 服务网关.html.89a43b14.js" as="script" /><link rel="prefetch" href="/assets/1. 第一个SpringMVC程序.html.c0b37902.js" as="script" /><link rel="prefetch" href="/assets/10. 拦截器.html.705293e5.js" as="script" /><link rel="prefetch" href="/assets/2. 配置视图解析器.html.3ebe496e.js" as="script" /><link rel="prefetch" href="/assets/3. 控制请求方式.html.e2ed59c7.js" as="script" /><link rel="prefetch" href="/assets/4. 处理器方法的参数.html.1b58cfe2.js" as="script" /><link rel="prefetch" href="/assets/5. 处理器方法的返回值.html.ab584e80.js" as="script" /><link rel="prefetch" href="/assets/6. url-pattern.html.c38eadb0.js" as="script" /><link rel="prefetch" href="/assets/7. SSM整合.html.d60536e4.js" as="script" /><link rel="prefetch" href="/assets/8. 请求重定向和转发.html.aa173cc4.js" as="script" /><link rel="prefetch" href="/assets/9. 异常处理.html.80dd2695.js" as="script" /><link rel="prefetch" href="/assets/index.html.1a983f30.js" as="script" /><link rel="prefetch" href="/assets/ThreadLocal.html.c6ae8548.js" as="script" /><link rel="prefetch" href="/assets/1. Dubbo 框架.html.0796df22.js" as="script" /><link rel="prefetch" href="/assets/2. 直连方式.html.35aa9517.js" as="script" /><link rel="prefetch" href="/assets/3. 改造 Dubbo 项目.html.380888d7.js" as="script" /><link rel="prefetch" href="/assets/4. 常用标签.html.5de61e9a.js" as="script" /><link rel="prefetch" href="/assets/5. 注册中心-Zookeeper.html.060470d2.js" as="script" /><link rel="prefetch" href="/assets/6. 使用 Zookeeper.html.986075bf.js" as="script" /><link rel="prefetch" href="/assets/7. Dubbo 的配置.html.74341687.js" as="script" /><link rel="prefetch" href="/assets/8. 监控中心.html.b7b0cab2.js" as="script" /><link rel="prefetch" href="/assets/index.html.0f30df47.js" as="script" /><link rel="prefetch" href="/assets/404.html.326b14c4.js" as="script" /><link rel="prefetch" href="/assets/index.html.1a3b71b5.js" as="script" /><link rel="prefetch" href="/assets/index.html.1b974156.js" as="script" /><link rel="prefetch" href="/assets/index.html.651691e2.js" as="script" /><link rel="prefetch" href="/assets/index.html.e2606eb8.js" as="script" /><link rel="prefetch" href="/assets/index.html.735c2dab.js" as="script" /><link rel="prefetch" href="/assets/index.html.89fb31a6.js" as="script" /><link rel="prefetch" href="/assets/index.html.bc3d2b77.js" as="script" /><link rel="prefetch" href="/assets/index.html.1e23b2a6.js" as="script" /><link rel="prefetch" href="/assets/index.html.db5e3287.js" as="script" /><link rel="prefetch" href="/assets/index.html.25ee1129.js" as="script" /><link rel="prefetch" href="/assets/index.html.4722db9f.js" as="script" /><link rel="prefetch" href="/assets/index.html.4072d6ac.js" as="script" /><link rel="prefetch" href="/assets/index.html.7ac11d6e.js" as="script" /><link rel="prefetch" href="/assets/index.html.019f9158.js" as="script" /><link rel="prefetch" href="/assets/index.html.d70ec3fa.js" as="script" /><link rel="prefetch" href="/assets/index.html.b1c40ad6.js" as="script" /><link rel="prefetch" href="/assets/index.html.f0db9e83.js" as="script" /><link rel="prefetch" href="/assets/index.html.c363841e.js" as="script" /><link rel="prefetch" href="/assets/index.html.5dc734dc.js" as="script" /><link rel="prefetch" href="/assets/index.html.565f195f.js" as="script" /><link rel="prefetch" href="/assets/index.html.25880373.js" as="script" /><link rel="prefetch" href="/assets/index.html.1d7c0704.js" as="script" /><link rel="prefetch" href="/assets/index.html.74d2cc1f.js" as="script" /><link rel="prefetch" href="/assets/1. VMware.html.d93e34af.js" as="script" /><link rel="prefetch" href="/assets/2. 文件管理.html.9f75d9cc.js" as="script" /><link rel="prefetch" href="/assets/3. 系统管理.html.fdc714a6.js" as="script" /><link rel="prefetch" href="/assets/4. 用户和组.html.ba1bd0ff.js" as="script" /><link rel="prefetch" href="/assets/5. 软件包管理.html.a7f85a92.js" as="script" /><link rel="prefetch" href="/assets/6. JavaEE环境搭建.html.639a0e3a.js" as="script" /><link rel="prefetch" href="/assets/index.html.e51b9e1c.js" as="script" /><link rel="prefetch" href="/assets/1. Vue 核心.html.19f5b523.js" as="script" /><link rel="prefetch" href="/assets/2. 组件化编程.html.3e8cea17.js" as="script" /><link rel="prefetch" href="/assets/3. 脚手架.html.33fba67a.js" as="script" /><link rel="prefetch" href="/assets/index.html.369663f5.js" as="script" /><link rel="prefetch" href="/assets/index.html.e55a63c3.js" as="script" /><link rel="prefetch" href="/assets/@RestController 指定主路径无效踩坑.html.e6f11d3d.js" as="script" /><link rel="prefetch" href="/assets/@XXmapping注解.html.42f9c765.js" as="script" /><link rel="prefetch" href="/assets/Cookie 存 JSON.html.618422a8.js" as="script" /><link rel="prefetch" href="/assets/Filter 过滤器.html.78bcce68.js" as="script" /><link rel="prefetch" href="/assets/SSM 环境搭建.html.685ad08e.js" as="script" /><link rel="prefetch" href="/assets/TypeReference 获取泛型属性.html.3af815cc.js" as="script" /><link rel="prefetch" href="/assets/index.html.6a24f411.js" as="script" /><link rel="prefetch" href="/assets/resultType_int 返回值是 null.html.2b1ec241.js" as="script" /><link rel="prefetch" href="/assets/sentinel 规则持久化.html.380e634c.js" as="script" /><link rel="prefetch" href="/assets/v-modeldisabled 和 disabled 踩坑.html.3d5c2d25.js" as="script" /><link rel="prefetch" href="/assets/函数式编程.html.6dc57c8e.js" as="script" /><link rel="prefetch" href="/assets/原来 @Autowired 注解还可以这么玩？.html.300518db.js" as="script" /><link rel="prefetch" href="/assets/处理器方法的返回值.html.ed40b607.js" as="script" /><link rel="prefetch" href="/assets/请求转发与请求重定向.html.e7898137.js" as="script" /><link rel="prefetch" href="/assets/1.设计模式七大原则.html.e1740b30.js" as="script" /><link rel="prefetch" href="/assets/2.创建型模式.html.b6536c06.js" as="script" /><link rel="prefetch" href="/assets/全局异常处理.html.238d1e8b.js" as="script" /><link rel="prefetch" href="/assets/分页查询.html.c98511ce.js" as="script" /><link rel="prefetch" href="/assets/用户中心.html.28736e7a.js" as="script" /><link rel="prefetch" href="/assets/自定义消息转换器.html.bdf996da.js" as="script" /><link rel="prefetch" href="/assets/自定义自动填充.html.b7d93732.js" as="script" /><link rel="prefetch" href="/assets/1. Java语言概述与开发环境.html.e7ad4c82.js" as="script" /><link rel="prefetch" href="/assets/10. 面向对象（下）.html.793a6a87.js" as="script" /><link rel="prefetch" href="/assets/11. 与运行环境交互.html.acbf59f3.js" as="script" /><link rel="prefetch" href="/assets/12. Java集合.html.b3c0d227.js" as="script" /><link rel="prefetch" href="/assets/13. 泛型.html.38e200e6.js" as="script" /><link rel="prefetch" href="/assets/14. 函数式编程.html.2da3642c.js" as="script" /><link rel="prefetch" href="/assets/15. 异常处理.html.d54e8e7b.js" as="script" /><link rel="prefetch" href="/assets/16. 注解.html.4487613b.js" as="script" /><link rel="prefetch" href="/assets/17. IO流.html.b2c0f2c9.js" as="script" /><link rel="prefetch" href="/assets/18. 多线程.html.c3cb0662.js" as="script" /><link rel="prefetch" href="/assets/19. 类加载机制与反射.html.b6d8560b.js" as="script" /><link rel="prefetch" href="/assets/2. 第一个java程序.html.a927944f.js" as="script" /><link rel="prefetch" href="/assets/3. Java程序的基本规则.html.64896f89.js" as="script" /><link rel="prefetch" href="/assets/4. 数据类型.html.d8a92f01.js" as="script" /><link rel="prefetch" href="/assets/5. 运算符.html.313e934a.js" as="script" /><link rel="prefetch" href="/assets/6. 流程控制.html.d06e55f1.js" as="script" /><link rel="prefetch" href="/assets/7. 面向对象（上）.html.5a565fec.js" as="script" /><link rel="prefetch" href="/assets/8. 数组.html.b6899710.js" as="script" /><link rel="prefetch" href="/assets/9. 数组的常见算法.html.f29fc4d8.js" as="script" /><link rel="prefetch" href="/assets/1. 创建与管理数据库.html.a741b498.js" as="script" /><link rel="prefetch" href="/assets/2. 创建与管理数据表.html.e3b34473.js" as="script" /><link rel="prefetch" href="/assets/3. 约束管理.html.9e0fc98f.js" as="script" /><link rel="prefetch" href="/assets/4. 数据表的基本操作.html.524d09cf.js" as="script" /><link rel="prefetch" href="/assets/5. 视图.html.32cdb6fc.js" as="script" /><link rel="prefetch" href="/assets/6. 索引.html.f8084397.js" as="script" /><link rel="prefetch" href="/assets/7. 事务.html.a581049f.js" as="script" /><link rel="prefetch" href="/assets/1. 准备.html.65109ac1.js" as="script" /><link rel="prefetch" href="/assets/10. 注解.html.c736a02b.js" as="script" /><link rel="prefetch" href="/assets/11. 复杂查询环境搭建.html.7ae44f94.js" as="script" /><link rel="prefetch" href="/assets/12. 动态 SQL.html.20335c91.js" as="script" /><link rel="prefetch" href="/assets/13. MybatisPlus-基础篇.html.90c54565.js" as="script" /><link rel="prefetch" href="/assets/14. MybatisPlus-高级篇.html.044cbad0.js" as="script" /><link rel="prefetch" href="/assets/2. 使用.html.7441f6fa.js" as="script" /><link rel="prefetch" href="/assets/3. 主要类介绍.html.3456561d.js" as="script" /><link rel="prefetch" href="/assets/4. 配置文件详解.html.c25f63b6.js" as="script" /><link rel="prefetch" href="/assets/5. CRUD.html.572623c1.js" as="script" /><link rel="prefetch" href="/assets/6. 配置 environments.html.8ef52d91.js" as="script" /><link rel="prefetch" href="/assets/7. ResultMap 结果集映射.html.04111ee2.js" as="script" /><link rel="prefetch" href="/assets/8. 日志.html.4d473967.js" as="script" /><link rel="prefetch" href="/assets/9. 分页.html.b5272566.js" as="script" /><link rel="prefetch" href="/assets/index.html.8e6d03ea.js" as="script" /><link rel="prefetch" href="/assets/0. Maven.html.eb162d98.js" as="script" /><link rel="prefetch" href="/assets/1. HTML.html.e0dfe6b5.js" as="script" /><link rel="prefetch" href="/assets/10. JavaBean.html.1e7f766e.js" as="script" /><link rel="prefetch" href="/assets/11. MVC 模式与三层架构的区别.html.678bf1c6.js" as="script" /><link rel="prefetch" href="/assets/12. Filter.html.2629679e.js" as="script" /><link rel="prefetch" href="/assets/13. 监听器.html.1b4fbfba.js" as="script" /><link rel="prefetch" href="/assets/14. JDBC.html.9a2d7fbd.js" as="script" /><link rel="prefetch" href="/assets/15. Ajax.html.d1494916.js" as="script" /><link rel="prefetch" href="/assets/2. CSS.html.96b6f4e4.js" as="script" /><link rel="prefetch" href="/assets/3. JavaScript.html.0afe1c4c.js" as="script" /><link rel="prefetch" href="/assets/4. jQuery.html.753fc880.js" as="script" /><link rel="prefetch" href="/assets/5. xml 和 json.html.8d5ce0bd.js" as="script" /><link rel="prefetch" href="/assets/6. tomcat.html.951bf1e3.js" as="script" /><link rel="prefetch" href="/assets/7. Servlet.html.48093b71.js" as="script" /><link rel="prefetch" href="/assets/8. Cookie 和 Session.html.67d04ffd.js" as="script" /><link rel="prefetch" href="/assets/9. JSP.html.8a36c012.js" as="script" /><link rel="prefetch" href="/assets/1. Redis 常见命令.html.faac795f.js" as="script" /><link rel="prefetch" href="/assets/2. Redis 的 Java 客户端.html.8de9a0aa.js" as="script" /><link rel="prefetch" href="/assets/index.html.9acd2191.js" as="script" /><link rel="prefetch" href="/assets/1. 短信登录.html.a53c846b.js" as="script" /><link rel="prefetch" href="/assets/10. 用户签到.html.bd82ea43.js" as="script" /><link rel="prefetch" href="/assets/11. UV统计.html.8acf0e03.js" as="script" /><link rel="prefetch" href="/assets/2. 商户查询缓存.html.f79c2f46.js" as="script" /><link rel="prefetch" href="/assets/3. 优惠券秒杀.html.f520c154.js" as="script" /><link rel="prefetch" href="/assets/4. 分布式锁.html.43f90cfc.js" as="script" /><link rel="prefetch" href="/assets/5. 秒杀优化.html.e33d878e.js" as="script" /><link rel="prefetch" href="/assets/6. Redis 消息队列.html.20632a09.js" as="script" /><link rel="prefetch" href="/assets/7. 达人探店.html.d6854d1c.js" as="script" /><link rel="prefetch" href="/assets/8. 好友关注.html.bebaeb74.js" as="script" /><link rel="prefetch" href="/assets/9. 附近商户.html.67b2addb.js" as="script" /><link rel="prefetch" href="/assets/1. IOC.html.df43f93d.js" as="script" /><link rel="prefetch" href="/assets/10. 整合 Mybatis.html.9556f05d.js" as="script" /><link rel="prefetch" href="/assets/11. 事务.html.6271a4b8.js" as="script" /><link rel="prefetch" href="/assets/12.  web 项目中使用容器对象.html.fcd8086d.js" as="script" /><link rel="prefetch" href="/assets/2. Spring创建对象.html.a5cc65e5.js" as="script" /><link rel="prefetch" href="/assets/3. DI 依赖注入.html.ecfffa30.js" as="script" /><link rel="prefetch" href="/assets/4. Spring 配置.html.53018b75.js" as="script" /><link rel="prefetch" href="/assets/5. Bean 自动装配.html.d355bd4d.js" as="script" /><link rel="prefetch" href="/assets/6. 使用注解开发.html.5d4b8568.js" as="script" /><link rel="prefetch" href="/assets/7. 使用 java 方式配置 Spring.html.f4980188.js" as="script" /><link rel="prefetch" href="/assets/8. 代理模式.html.30f5f270.js" as="script" /><link rel="prefetch" href="/assets/9. Spring AOP.html.953f4102.js" as="script" /><link rel="prefetch" href="/assets/1. SpringBoot.html.34352e8a.js" as="script" /><link rel="prefetch" href="/assets/2. JavaConfig.html.5ca36d35.js" as="script" /><link rel="prefetch" href="/assets/3. Web组件.html.1bf1422d.js" as="script" /><link rel="prefetch" href="/assets/4. ORM 操作 MySQL.html.9e38ad6f.js" as="script" /><link rel="prefetch" href="/assets/5. RESTful.html.c4a2a3ca.js" as="script" /><link rel="prefetch" href="/assets/6. 总结.html.29c7ea10.js" as="script" /><link rel="prefetch" href="/assets/index.html.1c3b4555.js" as="script" /><link rel="prefetch" href="/assets/1. 认识微服务.html.8069eb3c.js" as="script" /><link rel="prefetch" href="/assets/10. 初识 Docker.html.2063fd02.js" as="script" /><link rel="prefetch" href="/assets/11. Centos 7 安装 Docker.html.e6ce5da1.js" as="script" /><link rel="prefetch" href="/assets/12. Docker 基本操作.html.52db587a.js" as="script" /><link rel="prefetch" href="/assets/13. Dockerfile 自定义镜像.html.aa64809a.js" as="script" /><link rel="prefetch" href="/assets/14. Docker-Compose.html.a2897d14.js" as="script" /><link rel="prefetch" href="/assets/15. Docker 镜像仓库.html.4e0484e4.js" as="script" /><link rel="prefetch" href="/assets/16. 初识MQ.html.fd3b9239.js" as="script" /><link rel="prefetch" href="/assets/17. RabbitMQ 安装.html.61ef0d4c.js" as="script" /><link rel="prefetch" href="/assets/18. MQ 快速入门.html.c988f0a3.js" as="script" /><link rel="prefetch" href="/assets/19. SpringAMQP.html.28660037.js" as="script" /><link rel="prefetch" href="/assets/2. 服务的远程调用.html.b59a0ac4.js" as="script" /><link rel="prefetch" href="/assets/20. elasticsearch.html.7f681beb.js" as="script" /><link rel="prefetch" href="/assets/21. 安装 es、kibana.html.4e2c8014.js" as="script" /><link rel="prefetch" href="/assets/22. 索引库操作.html.830b232d.js" as="script" /><link rel="prefetch" href="/assets/23. 文档操作.html.69927c94.js" as="script" /><link rel="prefetch" href="/assets/24. RestAPI.html.13b0f1a6.js" as="script" /><link rel="prefetch" href="/assets/25. RestClient 操作文档.html.06c750d7.js" as="script" /><link rel="prefetch" href="/assets/26. DSL查询文档.html.b0682091.js" as="script" /><link rel="prefetch" href="/assets/27. 搜索结果处理.html.adcc03cd.js" as="script" /><link rel="prefetch" href="/assets/28. RestClient 查询文档.html.7b739267.js" as="script" /><link rel="prefetch" href="/assets/29. 黑马旅游案例.html.79d72b57.js" as="script" /><link rel="prefetch" href="/assets/3. Eureka 注册中心.html.fdf7f361.js" as="script" /><link rel="prefetch" href="/assets/30. 数据聚合.html.69f38ae7.js" as="script" /><link rel="prefetch" href="/assets/31. 自动补全.html.115e95eb.js" as="script" /><link rel="prefetch" href="/assets/32. 数据同步.html.d17f82e8.js" as="script" /><link rel="prefetch" href="/assets/33. 集群.html.19fa8d1a.js" as="script" /><link rel="prefetch" href="/assets/34. 微服务保护.html.7d648f6f.js" as="script" /><link rel="prefetch" href="/assets/4. Ribbon 负载均衡.html.647b34ec.js" as="script" /><link rel="prefetch" href="/assets/5. Nacos 注册中心.html.9e487afe.js" as="script" /><link rel="prefetch" href="/assets/6. Nacos 配置管理.html.47d1a60b.js" as="script" /><link rel="prefetch" href="/assets/7. Nacos 集群搭建.html.d7445874.js" as="script" /><link rel="prefetch" href="/assets/8. Feign 远程调用.html.50ac5111.js" as="script" /><link rel="prefetch" href="/assets/9. Gateway 服务网关.html.f6525a51.js" as="script" /><link rel="prefetch" href="/assets/1. 第一个SpringMVC程序.html.833ef248.js" as="script" /><link rel="prefetch" href="/assets/10. 拦截器.html.81e3b381.js" as="script" /><link rel="prefetch" href="/assets/2. 配置视图解析器.html.7ecaa19e.js" as="script" /><link rel="prefetch" href="/assets/3. 控制请求方式.html.857e85a3.js" as="script" /><link rel="prefetch" href="/assets/4. 处理器方法的参数.html.ab3de4ad.js" as="script" /><link rel="prefetch" href="/assets/5. 处理器方法的返回值.html.038013d8.js" as="script" /><link rel="prefetch" href="/assets/6. url-pattern.html.a6c71308.js" as="script" /><link rel="prefetch" href="/assets/7. SSM整合.html.ef054bee.js" as="script" /><link rel="prefetch" href="/assets/8. 请求重定向和转发.html.af08283a.js" as="script" /><link rel="prefetch" href="/assets/9. 异常处理.html.2bf3c600.js" as="script" /><link rel="prefetch" href="/assets/index.html.908d7baf.js" as="script" /><link rel="prefetch" href="/assets/ThreadLocal.html.a880caca.js" as="script" /><link rel="prefetch" href="/assets/1. Dubbo 框架.html.8699fa14.js" as="script" /><link rel="prefetch" href="/assets/2. 直连方式.html.be12c2f1.js" as="script" /><link rel="prefetch" href="/assets/3. 改造 Dubbo 项目.html.f6a58387.js" as="script" /><link rel="prefetch" href="/assets/4. 常用标签.html.b7c6b5a2.js" as="script" /><link rel="prefetch" href="/assets/5. 注册中心-Zookeeper.html.03d855f0.js" as="script" /><link rel="prefetch" href="/assets/6. 使用 Zookeeper.html.131313b6.js" as="script" /><link rel="prefetch" href="/assets/7. Dubbo 的配置.html.7c71e8e7.js" as="script" /><link rel="prefetch" href="/assets/8. 监控中心.html.513378e5.js" as="script" /><link rel="prefetch" href="/assets/index.html.96f0c6a9.js" as="script" /><link rel="prefetch" href="/assets/404.html.d8e0dab7.js" as="script" /><link rel="prefetch" href="/assets/index.html.3d16496c.js" as="script" /><link rel="prefetch" href="/assets/index.html.490cc3ee.js" as="script" /><link rel="prefetch" href="/assets/index.html.1f639a47.js" as="script" /><link rel="prefetch" href="/assets/index.html.6a90ba69.js" as="script" /><link rel="prefetch" href="/assets/index.html.87c8b5b9.js" as="script" /><link rel="prefetch" href="/assets/index.html.523fac82.js" as="script" /><link rel="prefetch" href="/assets/index.html.d5afa1b3.js" as="script" /><link rel="prefetch" href="/assets/index.html.190ac9f7.js" as="script" /><link rel="prefetch" href="/assets/index.html.3a308ab8.js" as="script" /><link rel="prefetch" href="/assets/index.html.0230d24f.js" as="script" /><link rel="prefetch" href="/assets/index.html.f01fe790.js" as="script" /><link rel="prefetch" href="/assets/index.html.576a7ecd.js" as="script" /><link rel="prefetch" href="/assets/index.html.4fd4d94e.js" as="script" /><link rel="prefetch" href="/assets/index.html.6890f8d1.js" as="script" /><link rel="prefetch" href="/assets/index.html.68fab233.js" as="script" /><link rel="prefetch" href="/assets/index.html.641b6e3a.js" as="script" /><link rel="prefetch" href="/assets/index.html.c112e570.js" as="script" /><link rel="prefetch" href="/assets/index.html.7bb84d8d.js" as="script" /><link rel="prefetch" href="/assets/index.html.9f00ad58.js" as="script" /><link rel="prefetch" href="/assets/index.html.c77f533b.js" as="script" /><link rel="prefetch" href="/assets/index.html.5e002860.js" as="script" /><link rel="prefetch" href="/assets/photoswipe.esm.a73472bf.js" as="script" />
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/" class="brand"><img class="logo" src="/logo.svg" alt="空~"><!----><span class="site-name hide-in-pad">空~</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/" class="nav-link" aria-label="主页"><span class="icon iconfont icon-home"></span>主页<!----></a></div><div class="nav-item hide-in-mobile"><a href="/docs/guide/" class="nav-link" aria-label="学习指南"><span class="icon iconfont icon-creative"></span>学习指南<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Java 基础"><span class="title"><span class="icon iconfont icon-java"></span>Java 基础</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/docs/Java%20%E5%9F%BA%E7%A1%80/Java/1.%20Java%E8%AF%AD%E8%A8%80%E6%A6%82%E8%BF%B0%E4%B8%8E%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83.html" class="nav-link" aria-label="JavaSE"><span class="icon iconfont icon-java"></span>JavaSE<!----></a></li><li class="dropdown-item"><a href="/docs/Java%20%E5%9F%BA%E7%A1%80/MySQL/1.%20%E5%88%9B%E5%BB%BA%E4%B8%8E%E7%AE%A1%E7%90%86%E6%95%B0%E6%8D%AE%E5%BA%93.html" class="nav-link" aria-label="MySQL"><span class="icon iconfont icon-mysql"></span>MySQL<!----></a></li><li class="dropdown-item"><a href="/docs/Java%20%E5%9F%BA%E7%A1%80/javaWeb/0.%20Maven.html" class="nav-link" aria-label="JavaWeb"><span class="icon iconfont icon-Apache"></span>JavaWeb<!----></a></li><li class="dropdown-item"><a href="/docs/Java%20%E5%9F%BA%E7%A1%80/Mybatis/" class="nav-link" aria-label="Mybatis"><span class="icon iconfont icon-stack"></span>Mybatis<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Spring系列"><span class="title"><span class="icon iconfont icon-stack"></span>Spring系列</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/docs/Spring%20%E7%B3%BB%E5%88%97/Spring/1.%20IOC.html" class="nav-link" aria-label="Spring"><span class="icon iconfont icon-module"></span>Spring<!----></a></li><li class="dropdown-item"><a href="/docs/Spring%20%E7%B3%BB%E5%88%97/SpringMVC/" class="nav-link" aria-label="SpringMVC"><span class="icon iconfont icon-module"></span>SpringMVC<!----></a></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>SpringBoot</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/docs/Spring%20%E7%B3%BB%E5%88%97/SpringBoot/" class="nav-link" aria-label="SpringBoot"><span class="icon iconfont icon-module"></span>SpringBoot<!----></a></li><li class="dropdown-subitem"><a href="/docs/Spring%20%E7%B3%BB%E5%88%97/SpringBoot/Dubbo/" class="nav-link" aria-label="Dubbo"><span class="icon iconfont icon-tool"></span>Dubbo<!----></a></li></ul></li><li class="dropdown-item"><a href="/docs/Spring%20%E7%B3%BB%E5%88%97/SpringCloud/1.%20%E8%AE%A4%E8%AF%86%E5%BE%AE%E6%9C%8D%E5%8A%A1.html" class="nav-link" aria-label="SpringCloud"><span class="icon iconfont icon-module"></span>SpringCloud<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a href="/docs/Git/" class="nav-link" aria-label="Git"><span class="icon iconfont icon-git"></span>Git<!----></a></div><div class="nav-item hide-in-mobile"><a href="/docs/Vue/" class="nav-link" aria-label="Vue"><span class="icon iconfont icon-vue"></span>Vue<!----></a></div><div class="nav-item hide-in-mobile"><a href="/docs/Linux/" class="nav-link" aria-label="Linux"><span class="icon iconfont icon-linux"></span>Linux<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Redis"><span class="title"><span class="icon iconfont icon-redis"></span>Redis</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/docs/Redis/Redis%20%E5%9F%BA%E7%A1%80/" class="nav-link" aria-label="Redis 基础"><span class="icon iconfont icon-redis"></span>Redis 基础<!----></a></li><li class="dropdown-item"><a href="/docs/Redis/Redis%20%E5%AE%9E%E6%88%98/1.%20%E7%9F%AD%E4%BF%A1%E7%99%BB%E5%BD%95.html" class="nav-link" aria-label="Redis 实战"><span class="icon iconfont icon-redis"></span>Redis 实战<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a href="/docs/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/1.%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B8%83%E5%A4%A7%E5%8E%9F%E5%88%99.html" class="nav-link" aria-label="设计模式"><span class="icon iconfont icon-tool"></span>设计模式<!----></a></div><div class="nav-item hide-in-mobile"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html" class="router-link-active router-link-exact-active nav-link active" aria-label="项目笔记"><span class="icon iconfont icon-tool"></span>项目笔记<!----></a></div><div class="nav-item hide-in-mobile"><a href="/docs/%E5%B0%8F%E8%AE%B0/" class="nav-link" aria-label="小记"><span class="icon iconfont icon-write"></span>小记<!----></a></div></nav><!--[--><!----><!--]--></div><div class="navbar-right"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/SurplusFate/SurplusFate.github.io" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button class="outlook-button" tabindex="-1" ariahidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><form class="search-box" role="search"><input type="search" placeholder="Search" autocomplete="off" spellcheck="false" value><!----></form><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><a href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E5%85%A8%E5%B1%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86.html" class="nav-link sidebar-link sidebar-page" aria-label="全局异常处理"><!---->全局异常处理<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2.html" class="nav-link sidebar-link sidebar-page" aria-label="分页查询"><!---->分页查询<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E7%94%A8%E6%88%B7%E4%B8%AD%E5%BF%83.html" class="nav-link sidebar-link sidebar-page" aria-label="用户中心"><!---->用户中心<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B6%88%E6%81%AF%E8%BD%AC%E6%8D%A2%E5%99%A8.html" class="nav-link sidebar-link sidebar-page" aria-label="自定义消息转换器"><!---->自定义消息转换器<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%87%AA%E5%AE%9A%E4%B9%89%E8%87%AA%E5%8A%A8%E5%A1%AB%E5%85%85.html" class="nav-link sidebar-link sidebar-page" aria-label="自定义自动填充"><!---->自定义自动填充<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="谷粒商城"><!---->谷粒商城<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#环境搭建" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="环境搭建"><!---->环境搭建<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#项目搭建" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="项目搭建"><!---->项目搭建<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#快速开发" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="快速开发"><!---->快速开发<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#配置修改" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="配置修改"><!---->配置修改<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#代码生成器" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="代码生成器"><!---->代码生成器<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#踩坑" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="踩坑"><!---->踩坑<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#限制微服务内存使用" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="限制微服务内存使用"><!---->限制微服务内存使用<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#windows-端口占用" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Windows 端口占用"><!---->Windows 端口占用<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#商品服务" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="商品服务"><!---->商品服务<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#三级分类" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="三级分类"><!---->三级分类<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#品牌管理" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="品牌管理"><!---->品牌管理<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#属性分组" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="属性分组"><!---->属性分组<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#新增商品" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="新增商品"><!---->新增商品<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#elasticsearch-8" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="ElasticSearch 8"><!---->ElasticSearch 8<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#环境准备" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="环境准备"><!---->环境准备<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#建立索引" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="建立索引"><!---->建立索引<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#按-id-读取" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="按 ID 读取"><!---->按 ID 读取<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#搜索" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="搜索"><!---->搜索<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#聚合" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="聚合"><!---->聚合<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#检索业务" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="检索业务"><!---->检索业务<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#分析" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="分析"><!---->分析<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#最终方案-存储结构" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="最终方案-存储结构"><!---->最终方案-存储结构<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#商品上架" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="商品上架"><!---->商品上架<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#性能优化" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="性能优化"><!---->性能优化<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#nginx-代理" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="nginx 代理"><!---->nginx 代理<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#nginx-反向代理" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="nginx 反向代理"><!---->nginx 反向代理<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#nginx-动静分离" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="nginx 动静分离"><!---->nginx 动静分离<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#优化查询三级分类数据" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="优化查询三级分类数据"><!---->优化查询三级分类数据<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#缓存和分布式锁" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="缓存和分布式锁"><!---->缓存和分布式锁<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#给业务中加入缓存" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="给业务中加入缓存"><!---->给业务中加入缓存<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#高并发下缓存失效问题" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="高并发下缓存失效问题"><!---->高并发下缓存失效问题<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#分布式锁" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="分布式锁"><!---->分布式锁<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#springcache" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="SpringCache"><!---->SpringCache<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#检索服务" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="检索服务"><!---->检索服务<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#异步与线程池" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="异步与线程池"><!---->异步与线程池<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->谷粒商城</h1><div class="page-info"><span class="author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="author-item" href="https://SurplusFate.github.io" target="_blank" rel="noopener noreferrer">空~</a></span><span property="author" content="空~"></span></span><!----><span class="date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span>2022年11月22日</span><meta property="datePublished" content="2022-11-22T01:45:39.000Z"></span><!----><!----><span class="reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 39 分钟</span><meta property="timeRequired" content="PT39M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">此页内容</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#环境搭建" class="router-link-active router-link-exact-active toc-link level2">环境搭建</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#项目搭建" class="router-link-active router-link-exact-active toc-link level2">项目搭建</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#快速开发" class="router-link-active router-link-exact-active toc-link level2">快速开发</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#配置修改" class="router-link-active router-link-exact-active toc-link level3">配置修改</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#代码生成器" class="router-link-active router-link-exact-active toc-link level3">代码生成器</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#踩坑" class="router-link-active router-link-exact-active toc-link level3">踩坑</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#限制微服务内存使用" class="router-link-active router-link-exact-active toc-link level2">限制微服务内存使用</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#windows-端口占用" class="router-link-active router-link-exact-active toc-link level2">Windows 端口占用</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#商品服务" class="router-link-active router-link-exact-active toc-link level2">商品服务</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#三级分类" class="router-link-active router-link-exact-active toc-link level3">三级分类</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#品牌管理" class="router-link-active router-link-exact-active toc-link level3">品牌管理</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#属性分组" class="router-link-active router-link-exact-active toc-link level3">属性分组</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#新增商品" class="router-link-active router-link-exact-active toc-link level3">新增商品</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#elasticsearch-8" class="router-link-active router-link-exact-active toc-link level2">ElasticSearch 8</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#环境准备" class="router-link-active router-link-exact-active toc-link level3">环境准备</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#建立索引" class="router-link-active router-link-exact-active toc-link level3">建立索引</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#按-id-读取" class="router-link-active router-link-exact-active toc-link level3">按 ID 读取</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#搜索" class="router-link-active router-link-exact-active toc-link level3">搜索</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#聚合" class="router-link-active router-link-exact-active toc-link level3">聚合</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#检索业务" class="router-link-active router-link-exact-active toc-link level2">检索业务</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#分析" class="router-link-active router-link-exact-active toc-link level3">分析</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#最终方案-存储结构" class="router-link-active router-link-exact-active toc-link level3">最终方案-存储结构</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#商品上架" class="router-link-active router-link-exact-active toc-link level2">商品上架</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#性能优化" class="router-link-active router-link-exact-active toc-link level2">性能优化</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#nginx-代理" class="router-link-active router-link-exact-active toc-link level3">nginx 代理</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#nginx-反向代理" class="router-link-active router-link-exact-active toc-link level3">nginx 反向代理</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#nginx-动静分离" class="router-link-active router-link-exact-active toc-link level3">nginx 动静分离</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#优化查询三级分类数据" class="router-link-active router-link-exact-active toc-link level3">优化查询三级分类数据</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#缓存和分布式锁" class="router-link-active router-link-exact-active toc-link level2">缓存和分布式锁</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#给业务中加入缓存" class="router-link-active router-link-exact-active toc-link level3">给业务中加入缓存</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#高并发下缓存失效问题" class="router-link-active router-link-exact-active toc-link level3">高并发下缓存失效问题</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#分布式锁" class="router-link-active router-link-exact-active toc-link level3">分布式锁</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#springcache" class="router-link-active router-link-exact-active toc-link level3">SpringCache</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#检索服务" class="router-link-active router-link-exact-active toc-link level3">检索服务</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E.html#异步与线程池" class="router-link-active router-link-exact-active toc-link level2">异步与线程池</a></li><!----><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="谷粒商城" tabindex="-1"><a class="header-anchor" href="#谷粒商城" aria-hidden="true">#</a> 谷粒商城</h1><h2 id="环境搭建" tabindex="-1"><a class="header-anchor" href="#环境搭建" aria-hidden="true">#</a> 环境搭建</h2><p>虚拟机, docker, docker 安装 mysql, docker 安装 redis, git</p><p>初始化数据库:</p><p><a href="%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/pms_catelog.sql">pms_catelog.sql</a></p><p><a href="%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/gulimall_oms.sql">gulimall_oms.sql</a></p><p><a href="%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/gulimall_pms.sql">gulimall_pms.sql</a></p><p><a href="%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/gulimall_sms.sql">gulimall_sms.sql</a></p><p><a href="%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/gulimall_ums.sql">gulimall_ums.sql</a></p><p><a href="%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/gulimall_wms.sql">gulimall_wms.sql</a></p><p><a href="%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%5Csys_menus.sql">sys_menus.sql</a></p><h2 id="项目搭建" tabindex="-1"><a class="header-anchor" href="#项目搭建" aria-hidden="true">#</a> 项目搭建</h2><h2 id="快速开发" tabindex="-1"><a class="header-anchor" href="#快速开发" aria-hidden="true">#</a> 快速开发</h2><p>人人开源或其他后台管理系统均可</p><p>人人开源后端:</p><p><a href="https://gitee.com/renrenio/renren-fast" target="_blank" rel="noopener noreferrer">renren-fast<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>前端:</p><p><a href="https://gitee.com/renrenio/renren-fast-vue" target="_blank" rel="noopener noreferrer">renren-fast-vue<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>前端说明文档: <a href="https://github.com/renrenio/renren-fast-vue/wiki" target="_blank" rel="noopener noreferrer">Home · renrenio/renren-fast-vue Wiki (github.com)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="配置修改" tabindex="-1"><a class="header-anchor" href="#配置修改" aria-hidden="true">#</a> 配置修改</h3><h4 id="后端" tabindex="-1"><a class="header-anchor" href="#后端" aria-hidden="true">#</a> 后端</h4><p>修改人人开源项目的 springboot 版本, 适配 springcloud 和 springcloud alibaba</p><p><a href="https://spring.io/projects/spring-cloud" target="_blank" rel="noopener noreferrer">Spring Cloud<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211171230387.png" alt="image.png"></p><p><strong>阿里官方概述:</strong></p><p>如果项目中需要使用 Spring Cloud Alibaba 2021.0.1.0 版本，请在项目中添加如下依赖：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.6.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2021.0.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2021.0.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>调整项目依赖:</strong></p><p>项目依赖报错可尝试调整依赖关系</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modules</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>gulimall-third-party<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>gulimall-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>gulimall-coupon<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>gulimall-member<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>gulimall-order<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>gulimall-product<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>gulimall-ware<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>renren-fast<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>gulimall-common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modules</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>调整依赖(可选):</strong></p><p>视频提供的源码, 没有进行统一的依赖管理, 并且使用了两个版本的 SpringBoot, 可尝试修改为统一版本</p><p>将部分依赖和工具类抽取出来, <strong>不是必须</strong>, 可按照自己的喜好来</p><p>调整后会出现较多的依赖报错, 需要调整依赖</p><blockquote><p><strong><!----></strong></p><p><strong><!----></strong></p><p>依赖和配置都最好是直接从父项目复制过去</p></blockquote><h4 id="前端" tabindex="-1"><a class="header-anchor" href="#前端" aria-hidden="true">#</a> 前端</h4><p>修改 node 版本为大于等于 8.11.1, 如果初始化失败可尝试使用 git 克隆人人开源原项目, 初始化后再用本地代码覆盖</p><p>官方文档: <a href="https://github.com/renrenio/renren-fast-vue/wiki/Getting-started#%E5%AE%89%E8%A3%85" target="_blank" rel="noopener noreferrer">安装<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211251755995.png" alt="image-20221125175558950"></p><p>推荐使用 nvm, 方便管理 node 版本</p><p><a href="https://nvm.uihtm.com/" target="_blank" rel="noopener noreferrer">nvm 文档手册 - nvm 是一个 nodejs 的版本管理工具 (uihtm.com)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><ul><li><code>nvm arch</code>：显示 node 是运行在 32 位还是 64 位。</li><li><code>nvm install &lt;version&gt; [arch]</code> ：安装 node， version 是特定版本也可以是最新稳定版本 latest。可选参数 arch 指定安装 32 位还是 64 位版本，默认是系统位数。可以添加--insecure 绕过远程服务器的 SSL。</li><li><code>nvm list [available]</code> ：显示已安装的列表。可选参数 available，显示可安装的所有版本。list 可简化为 ls。</li><li><code>nvm on</code> ：开启 node.js 版本管理。</li><li><code>nvm off</code> ：关闭 node.js 版本管理。</li><li><code>nvm proxy [url]</code> ：设置下载代理。不加可选参数 url，显示当前代理。将 url 设置为 none 则移除代理。</li><li><code>nvm node_mirror [url]</code> ：设置 node 镜像。默认是 <a href="https://nodejs.org/dist/" target="_blank" rel="noopener noreferrer">https://nodejs.org/dist/<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。如果不写 url，则使用默认 url。设置后可至安装目录 settings.txt 文件查看，也可直接在该文件操作。</li><li><code>nvm npm_mirror [url]</code> ：设置 npm 镜像。<a href="https://github.com/npm/cli/archive/" target="_blank" rel="noopener noreferrer">https://github.com/npm/cli/archive/<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。如果不写 url，则使用默认 url。设置后可至安装目录 settings.txt 文件查看，也可直接在该文件操作。</li><li><code>nvm uninstall &lt;version&gt;</code> ：卸载指定版本 node。</li><li><code>nvm use [version] [arch]</code> ：使用制定版本 node。可指定 32/64 位。</li><li><code>nvm root [path]</code> ：设置存储不同版本 node 的目录。如果未设置，默认使用当前目录。</li><li><code>nvm version</code> ：显示 nvm 版本。version 可简化为 v</li></ul><p>错误解决:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>Module build failed: Error: Node Sass does not yet support your current environment: Windows <span class="token number">64</span>-bit with Unsupported runtime <span class="token punctuation">(</span><span class="token number">83</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>sass 不支持当前的环境，那么在当前环境重新安装一下就好了</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code> <span class="token function">npm</span> uninstall <span class="token parameter variable">--save</span> node-sass
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> <span class="token parameter variable">--save</span> node-sass
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="代码生成器" tabindex="-1"><a class="header-anchor" href="#代码生成器" aria-hidden="true">#</a> 代码生成器</h3><blockquote><p>生成的代码是前后端配套的, 可以直接使用</p></blockquote><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211181517360.png" alt="image-20221118150002822"></p><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211251745402.png" alt="image-20221125174553347"></p><h4 id="后端代码调整" tabindex="-1"><a class="header-anchor" href="#后端代码调整" aria-hidden="true">#</a> 后端代码调整</h4><blockquote><p>后端生成的代码实体类(<code>io.renren.modules.*.entity</code>)中可能不会标注 <code>@TableId</code> 要自己手动补充, 否则后续增删改查可能会出现 <code>Invalid bound statement (not found)</code></p><p>官方说明: <a href="https://baomidou.com/pages/f84a74/#%E5%87%BA%E7%8E%B0-invalid-bound-statement-not-found-%E5%BC%82%E5%B8%B8" target="_blank" rel="noopener noreferrer">https://baomidou.com/pages/f84a74/#出现-invalid-bound-statement-not-found-异常<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>mybatis-plus 拥有主键自动填充功能, 如果填充方式为(默认) <code>ASSIGN_ID</code>, 则会采用雪花算法生成 19 位长数字, 会导致前端精度丢失(17 位以后的数字全部变 0), 需要转换成字符串处理或者换一种填充方式</p><p>手动指定填充方式: 在配置文件中指定 <code>id-type: AUTO</code>, 或者 <code>@TableId(type = IdType.AUTO)</code>(<code>AUTO</code> 需要配合主键自增)</p></blockquote><h3 id="踩坑" tabindex="-1"><a class="header-anchor" href="#踩坑" aria-hidden="true">#</a> 踩坑</h3><h4 id="docker-容器突然连接不上" tabindex="-1"><a class="header-anchor" href="#docker-容器突然连接不上" aria-hidden="true">#</a> Docker 容器突然连接不上</h4><p>重启 Docker 后解决</p><p>可能原因:</p><ol><li><p>宿主机的 IP_FORWARD 功能失效</p></li><li><p>端口没开放</p></li></ol><p>查看 IP_FORWARD 功能有没有启用(1 表示已经启用, 0 表示未启用)</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sysctl</span> net.ipv4.ip_forward
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这里有可能显示是 1 但实际是 0; 将状态重置:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>systemctl restart network.service
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>手动写入:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">echo</span> <span class="token string">&#39;net.ipv4.ip_forward = 1&#39;</span> <span class="token operator">&gt;&gt;</span> /usr/lib/sysctl.d/50-default.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>加载配置文件:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sysctl</span> <span class="token parameter variable">-p</span> /usr/lib/sysctl.d/50-default.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>CentOS 7 下的一些其他相关命令:</p><p>查看 Docker 容器:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>有参数 <code>-a</code> 表示查看全部容器, 无参数表示查看正在运行的容器</p><p>查看开放的端口:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>firewall-cmd --list-ports
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>查看开放的服务:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>firewall-cmd --list-services
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>查看防火墙状态:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>systemctl status firewalld
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>关闭防火墙:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>systemctl stop firewalld
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>开启防火墙:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>systemctl start firewalld
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>打开指定端口:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>firewall-cmd <span class="token parameter variable">--permanent</span> --add-port<span class="token operator">=</span>端口号/协议
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>例如打开 8080 端口:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>firewall-cmd <span class="token parameter variable">--permanent</span> --add-port<span class="token operator">=</span><span class="token number">8080</span>/tcp
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>关闭端口:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>firewall-cmd <span class="token parameter variable">--permanent</span> --remove-port<span class="token operator">=</span>端口号/协议
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>重新载入生效:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>firewall-cmd <span class="token parameter variable">--reload</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>查询端口是否开放:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>firewall-cmd --query-port<span class="token operator">=</span>端口号/协议
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="docker-中的数据丢失" tabindex="-1"><a class="header-anchor" href="#docker-中的数据丢失" aria-hidden="true">#</a> <!----></h4><p>Docker 中的 MySQL 因为一次异常停止, 在重启后所有数据全部丢失, 且查询 root 权限显示正常, 实际连建表权限都没有!</p><blockquote><p><strong>容器一定要挂载数据卷!</strong></p></blockquote><h4 id="nacos2-连接不上-端口未开放" tabindex="-1"><a class="header-anchor" href="#nacos2-连接不上-端口未开放" aria-hidden="true">#</a> Nacos2 连接不上/端口未开放</h4><p>先是连接不上 nacos, 需要补充依赖:</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-bootstrap<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.0.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>尝试连接 nacos 的时候报了一个关于 9848 端口的错误, nacos2 还需要开放该端口:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>firewall-cmd <span class="token parameter variable">--permanent</span> --add-port<span class="token operator">=</span><span class="token number">9848</span>/tcp
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>重新载入生效:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>firewall-cmd <span class="token parameter variable">--reload</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>如果是把 nacos 部署在 docker 中, 则需要重新创建容器并设置端口, 可以使用 idea 连接 docker, 但延迟较大</p><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211171222224.png" alt="image.png"></p><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211171232265.png" alt="image.png"></p><p>删除 docker 容器命令:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> nacos
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>创建并运行 nacos 容器命令参考:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token punctuation">\</span>
<span class="token parameter variable">--name</span> nacos <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">MODE</span><span class="token operator">=</span>standalone <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">JVM_XMS</span><span class="token operator">=</span>512m <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">JVM_XMX</span><span class="token operator">=</span>512m <span class="token punctuation">\</span>
<span class="token parameter variable">-p</span> <span class="token number">8848</span>:8848 <span class="token punctuation">\</span>
<span class="token parameter variable">-p</span> <span class="token number">9848</span>:9848 <span class="token punctuation">\</span>
<span class="token parameter variable">-d</span> nacos/nacos-server:2.0.2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>详细配置列表:</p><p><a href="https://github.com/nacos-group/nacos-docker/blob/master/README_ZH.md#%E5%B1%9E%E6%80%A7%E9%85%8D%E7%BD%AE%E5%88%97%E8%A1%A8" target="_blank" rel="noopener noreferrer">github.com<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>重启 docker 命令:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>Systemctl restart <span class="token function">docker</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>idea 中显示 docker 状态有较大延迟, 没反应可尝试重新连接 docker</p><h4 id="idea-连不上-docker-中的-mysql5-7" tabindex="-1"><a class="header-anchor" href="#idea-连不上-docker-中的-mysql5-7" aria-hidden="true">#</a> idea 连不上 Docker 中的 MySQL5.7</h4><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211191918058.png" alt="image-20221119191826977"></p><p>需要添加配置</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>TLSv1,TLSv1.1,TLSv1.2,TLSv1.3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211191918688.png" alt="image-20221119191758437"></p><blockquote><p><strong>记得点应用！</strong></p></blockquote><h2 id="限制微服务内存使用" tabindex="-1"><a class="header-anchor" href="#限制微服务内存使用" aria-hidden="true">#</a> 限制微服务内存使用</h2><p>限制内存使用能有效降低电脑负载压力, 但限制太小会内存溢出(OOM)</p><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211251523724.png" alt="image-20221125152338482"></p><h2 id="windows-端口占用" tabindex="-1"><a class="header-anchor" href="#windows-端口占用" aria-hidden="true">#</a> Windows 端口占用</h2><p>查看所有占用的端口</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">netstat</span> <span class="token parameter variable">-ano</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>查看指定的端口</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">netstat</span> -aon<span class="token operator">|</span>findstr <span class="token string">&quot;端口号&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211260859274.png" alt="image"></p><p>查看占用端口的应用程序名称</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>tasklist<span class="token operator">|</span>findstr <span class="token string">&quot;PID&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211260859069.png" alt="image"></p><p>杀死该程序</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>taskkill /f /pid PID
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211260858486.png" alt="image"></p><h2 id="商品服务" tabindex="-1"><a class="header-anchor" href="#商品服务" aria-hidden="true">#</a> 商品服务</h2><h3 id="三级分类" tabindex="-1"><a class="header-anchor" href="#三级分类" aria-hidden="true">#</a> 三级分类</h3><h4 id="递归查询父子节点" tabindex="-1"><a class="header-anchor" href="#递归查询父子节点" aria-hidden="true">#</a> 递归查询父子节点</h4><p>数据库父类的 catId 就是子类的 parentId;</p><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211181000192.png" alt="image-20221118100041911"></p><p>获取所有数据, 筛选出最高级父类;</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> tree <span class="token operator">=</span> categoryService<span class="token punctuation">.</span><span class="token function">getTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryDTO</span><span class="token punctuation">&gt;</span></span> dtoTree <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 全部数据</span>
        tree<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>t <span class="token operator">-&gt;</span> dtoTree<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token class-name">CategoryDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过父类 id 和子类 parentid 进行关联;</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 1. 找到所有的一级分类</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryDTO</span><span class="token punctuation">&gt;</span></span> leave1 <span class="token operator">=</span>
        dtoTree<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token function">getParentCid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token comment">// 2. 递归获取所有子菜单</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>
                        r <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                            r<span class="token punctuation">.</span><span class="token function">setChildren</span><span class="token punctuation">(</span><span class="token function">getChildren</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> dtoTree<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span> r<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                <span class="token punctuation">)</span>
                <span class="token comment">// 3. 排序 踩坑 Integer 包装类赋值为 0 的情况下会自动转成 null</span>
                <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token class-name">Comparator</span><span class="token punctuation">.</span><span class="token function">comparingInt</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getSort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>利用递归进行多级查询</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryDTO</span><span class="token punctuation">&gt;</span></span> <span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token class-name">CategoryDTO</span> parent<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryDTO</span><span class="token punctuation">&gt;</span></span> allData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
            allData<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>c <span class="token operator">-&gt;</span> c<span class="token punctuation">.</span><span class="token function">getParentCid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>p <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                        p<span class="token punctuation">.</span><span class="token function">setChildren</span><span class="token punctuation">(</span><span class="token function">getChildren</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> allData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> p<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token class-name">Comparator</span><span class="token punctuation">.</span><span class="token function">comparingInt</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getSort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>自动生成的代码没有遵循数据库设计规范(缺少逻辑删除, 创建时间, 更新时间这三个字段), 如果希望自动生成的的代码正常运行需要手动补加</p><p>如果后端依赖或者配置文件调整不当, 最终会导致项目默认的分页功能失效, 前端会一页展示所有数据</p></blockquote><h4 id="gateway-路由配置" tabindex="-1"><a class="header-anchor" href="#gateway-路由配置" aria-hidden="true">#</a> Gateway 路由配置</h4><h5 id="负载均衡-错误-503" tabindex="-1"><a class="header-anchor" href="#负载均衡-错误-503" aria-hidden="true">#</a> 负载均衡/错误 503</h5><p>单独在 gateway 启用负载均衡需要添加 loadbalancer 依赖, 否则会报 <strong>503 错误</strong>:</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-loadbalancer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211181626349.png" alt="image-20221118162622309"></p><h5 id="跨域出现-origin-重复" tabindex="-1"><a class="header-anchor" href="#跨域出现-origin-重复" aria-hidden="true">#</a> 跨域出现 origin 重复</h5><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211181629661.png" alt="image-20221118162924623"></p><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211181629239.png" alt="image-20221118162951157"></p><p>因为人人开源配置了默认的跨域</p><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211261003099.png" alt="image-20221126100346374"></p><p>可以将默认跨域注释掉或者使用 gateway 的配置解决</p><blockquote><p>在官方文档检索 <code>CORS</code> 可查找到相关信息</p></blockquote><p><a href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-deduperesponseheader-gatewayfilter-factory" target="_blank" rel="noopener noreferrer">https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-deduperesponseheader-gatewayfilter-factory<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211181623856.png" alt="image-20221118162342771"></p><h4 id="逻辑删除" tabindex="-1"><a class="header-anchor" href="#逻辑删除" aria-hidden="true">#</a> 逻辑删除</h4><p>除了按照 <a href="https://baomidou.com/pages/6b03c5/#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95" target="_blank" rel="noopener noreferrer">MyBatis-Plus<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 官方文档的配置配好以外, 别忘记补充字段</p><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211220913005.png" alt="image-20221122091208793"></p><h3 id="品牌管理" tabindex="-1"><a class="header-anchor" href="#品牌管理" aria-hidden="true">#</a> 品牌管理</h3><h4 id="oss-对象存储" tabindex="-1"><a class="header-anchor" href="#oss-对象存储" aria-hidden="true">#</a> OSS 对象存储</h4><p>OSS 的依赖对 nacos 依赖有版本要求, 不然可能会报错: <code>Parameter 0 of method inetIPv6Util in com.alibaba.cloud.nacos.utils.UtilIPv6AutoConfiguration required a single bean, but 2 were found</code></p><p>相关信息:</p><blockquote><p><a href="https://github.com/alibaba/spring-cloud-alibaba/issues/2789" target="_blank" rel="noopener noreferrer">Parameter 0 of method inetIPv6Util in com.alibaba.cloud.nacos.utils.UtilIPv6AutoConfiguration required a single bean, but 2 were found: · Issue #2789 · alibaba/spring-cloud-alibaba (github.com)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><p>SpringBoot 版本:</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.8.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/&gt;</span></span> <span class="token comment">&lt;!-- lookup parent from repository --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>SpringBootCloud 版本 和 SpringBootCloudAlibaba 版本: :</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring-cloud.version</span><span class="token punctuation">&gt;</span></span>Greenwich.SR3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring-cloud.version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!--================--&gt;</span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring-cloud.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.0.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a href="https://github.com/alibaba/spring-cloud-alibaba/wiki/%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E#%E6%AF%95%E4%B8%9A%E7%89%88%E6%9C%AC%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB%E6%8E%A8%E8%8D%90%E4%BD%BF%E7%94%A8" target="_blank" rel="noopener noreferrer">版本依赖关系<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>:</p><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211221955132.png" alt="image-20221122195555783"></p><p><a href="https://github.com/alibaba/spring-cloud-alibaba/wiki/%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E#%E7%BB%84%E4%BB%B6%E7%89%88%E6%9C%AC%E5%85%B3%E7%B3%BB" target="_blank" rel="noopener noreferrer">组件版本关系<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>:</p><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211221957110.png" alt="image-20221122195726057"></p><p>简单示例:</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">spring.cloud.alicloud.oss.endpoint</span><span class="token punctuation">=</span><span class="token value attr-value">oss-cn-shenzhen.aliyuncs.com</span>
<span class="token key attr-name">spring.cloud.alicloud.secret-key</span><span class="token punctuation">=</span><span class="token value attr-value">6i2bWJMf********gINHyrK</span>
<span class="token key attr-name">spring.cloud.alicloud.access-key</span><span class="token punctuation">=</span><span class="token value attr-value">LTAI********3bKNEhY</span>
<span class="token key attr-name">spring.cloud.alicloud.oss.bucket</span><span class="token punctuation">=</span><span class="token value attr-value">bucketName</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OssController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">OSS</span> ossClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${oos.bucket}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> bucketName<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;oss&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">home</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> filetName <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        ossClient<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>bucketName<span class="token punctuation">,</span> date <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> filetName <span class="token operator">+</span> <span class="token string">&quot;.jpg&quot;</span><span class="token punctuation">,</span>
                <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">newInputStream</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;E:/imgs/4.jpg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;upload success&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置跨域:</p><p><a href="https://help.aliyun.com/document_detail/31925.html" target="_blank" rel="noopener noreferrer">JavaScript 客户端签名直传 (aliyun.com)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211222049592.png" alt="image-20221122204955494"></p><p>项目自带的参数配置:</p><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211222112735.png" alt="image-20221122211257117"></p><p>项目自带的 oss 配置, 可以做很好的参考:</p><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211222116402.png" alt="image-20221122211655333"></p><h4 id="jsr303-参数验证" tabindex="-1"><a class="header-anchor" href="#jsr303-参数验证" aria-hidden="true">#</a> JSR303 参数验证</h4><p>参考: <a href="https://developer.aliyun.com/article/761457#slide-8" target="_blank" rel="noopener noreferrer">Spring Boot 使用 JSR303 实现参数验证-阿里云开发者社区 (aliyun.com)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>JSR 是 Java Specification Requests 的缩写，即 Java 规范提案。</p><p>JSR-303 是 JAVA EE 6 中的一项子规范，叫做 Bean Validation。</p><h5 id="bean-validation-规范内嵌的约束注解" tabindex="-1"><a class="header-anchor" href="#bean-validation-规范内嵌的约束注解" aria-hidden="true">#</a> Bean Validation 规范内嵌的约束注解</h5><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211230835309.png" alt="181bd595afbbc00e8e2618bd485c0829bcb46fc7"></p><h5 id="实例" tabindex="-1"><a class="header-anchor" href="#实例" aria-hidden="true">#</a> 实例</h5><blockquote><ol><li>给 bean 属性添加 <code>javax.validation.constraints</code> 中的校验注解, 可自定义 <code>message</code> 消息</li><li>开启校验功能 <code>@Valid</code></li><li>紧跟在校验的 Bean 后添加一个 <code>BindingResult</code>，<code>BindingResult</code> 封装了前面 Bean 的校验结果</li></ol></blockquote><p>给 bean 属性添加校验注解</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BrandDTO</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Long</span> brandId<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@NotBlank</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">&quot;品牌名不能为空&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@URL</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">&quot;必须为合法的url地址&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> logo<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> descript<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Integer</span> showStatus<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Pattern</span><span class="token punctuation">(</span>regexp <span class="token operator">=</span> <span class="token string">&quot;^[a-zA-Z]$&quot;</span><span class="token punctuation">,</span> message <span class="token operator">=</span> <span class="token string">&quot;检索首字母必须为字母&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> firstLetter<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Min</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> message <span class="token operator">=</span> <span class="token string">&quot;排序必须大于0&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> sort<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>开启校验</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Valid</span> <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">BrandDTO</span> dto<span class="token punctuation">,</span> <span class="token class-name">BindingResult</span> bindingResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bindingResult<span class="token punctuation">.</span><span class="token function">hasErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span> <span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bindingResult<span class="token punctuation">.</span><span class="token function">getFieldErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> message <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">getDefaultMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> field <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span> field <span class="token punctuation">,</span> message <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Result</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    brandService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>dto<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="统一异常处理" tabindex="-1"><a class="header-anchor" href="#统一异常处理" aria-hidden="true">#</a> 统一异常处理</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestControllerAdvice</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">&quot;io.renren.modules.product.controller&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GlobalExceptionControllerAdvice</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span>value<span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">MethodArgumentNotValidException</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">,</span> <span class="token class-name">BindException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">handleVaildException</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">BindingResult</span> bindingResult <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">MethodArgumentNotValidException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            bindingResult <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">MethodArgumentNotValidException</span><span class="token punctuation">)</span>e<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBindingResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">BindException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            bindingResult <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BindException</span><span class="token punctuation">)</span>e<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBindingResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> errorMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bindingResult<span class="token punctuation">.</span><span class="token function">getFieldErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fieldError<span class="token punctuation">)</span><span class="token operator">-&gt;</span>
                errorMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>fieldError<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>fieldError<span class="token punctuation">.</span><span class="token function">getDefaultMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Result</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>errorMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用统一异常处理后就不需要逐个校验了</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Valid</span> <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">BrandDTO</span> dto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    brandService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>dto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="分组校验" tabindex="-1"><a class="header-anchor" href="#分组校验" aria-hidden="true">#</a> 分组校验</h5><p>新增和修改对于实体的校验规则是不同的，例如 id 是自增的时，新增时 id 要为空，修改则必须不为空；新增和修改，若用的恰好又是同一种实体，那就需要用到分组校验</p><p>校验注解都有一个 groups 属性，可以将校验注解分组，<code>@NotNull</code> 的源码：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token constant">METHOD</span><span class="token punctuation">,</span> <span class="token constant">FIELD</span><span class="token punctuation">,</span> <span class="token constant">ANNOTATION_TYPE</span><span class="token punctuation">,</span> <span class="token constant">CONSTRUCTOR</span><span class="token punctuation">,</span> <span class="token constant">PARAMETER</span><span class="token punctuation">,</span> <span class="token constant">TYPE_USE</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Repeatable</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Constraint</span><span class="token punctuation">(</span>validatedBy <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">NotNull</span> <span class="token punctuation">{</span>

    <span class="token class-name">String</span> <span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;{javax.validation.constraints.NotNull.message}&quot;</span><span class="token punctuation">;</span>

    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">groups</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Payload</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">payload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token constant">METHOD</span><span class="token punctuation">,</span> <span class="token constant">FIELD</span><span class="token punctuation">,</span> <span class="token constant">ANNOTATION_TYPE</span><span class="token punctuation">,</span> <span class="token constant">CONSTRUCTOR</span><span class="token punctuation">,</span> <span class="token constant">PARAMETER</span><span class="token punctuation">,</span> <span class="token constant">TYPE_USE</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Documented</span>
    <span class="token annotation punctuation">@interface</span> <span class="token class-name">List</span> <span class="token punctuation">{</span>

        <span class="token class-name">NotNull</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从源码可以看出 groups 是一个 Class&lt;?&gt;类型的数组，那么就可以创建一个 Groups.</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Groups</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Add</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span>  <span class="token class-name">Update</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>给 bean 属性的校验注解添加分组, 多个分组使用 <code>{}</code> 即可</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Null</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">&quot;新增不需要指定id&quot;</span> <span class="token punctuation">,</span> groups <span class="token operator">=</span> <span class="token class-name">Groups<span class="token punctuation">.</span>Add</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@NotNull</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">&quot;修改需要指定id&quot;</span> <span class="token punctuation">,</span> groups <span class="token operator">=</span> <span class="token class-name">Groups<span class="token punctuation">.</span>Update</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;品牌id&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">Long</span> brandId<span class="token punctuation">;</span>

<span class="token annotation punctuation">@URL</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">&quot;必须为合法的url地址&quot;</span><span class="token punctuation">,</span> groups <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">UpdateGroup</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">AddGroup</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;品牌logo地址&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> logo<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Controller 中原先的 <code>@Valid</code> 不能指定分组 ，需要替换成 <code>@Validated</code>, 并指定分组, 多个分组用 <code>{}</code> 即可</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Validated</span><span class="token punctuation">(</span><span class="token class-name">Groups<span class="token punctuation">.</span>Add</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">BrandDTO</span> dto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    brandService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>dto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>默认没有指定分组的校验注解在使用分组校验的情况下不会生效</p></blockquote><h5 id="自定义校验注解" tabindex="-1"><a class="header-anchor" href="#自定义校验注解" aria-hidden="true">#</a> 自定义校验注解</h5><h6 id="创建约束规则" tabindex="-1"><a class="header-anchor" href="#创建约束规则" aria-hidden="true">#</a> 创建约束规则</h6><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Constraint</span><span class="token punctuation">(</span>validatedBy <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token class-name">ListValueConstraintValidator</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token constant">METHOD</span><span class="token punctuation">,</span> <span class="token constant">FIELD</span><span class="token punctuation">,</span> <span class="token constant">ANNOTATION_TYPE</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">ListValue</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> <span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">groups</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Payload</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">payload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">vals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Bean Validation API 规范的要求：</p><ul><li><code>message</code> 属性, 这个属性被用来定义默认得消息模版, 当这个约束条件被验证失败的时候, 通过此属性来输出错误信息; 可以参考官方写法自定义一个配置文件</li><li><code>groups</code> 属性, 用于指定这个约束条件属于哪(些)个校验组. 这个的默认值必须是 Class&lt;?&gt; 类型数组</li><li><code>payload</code> 属性, Bean Validation API 的使用者可以通过此属性来给约束条件指定严重级别. 这个属性并不被 API 自身所使用</li></ul><p>注解信息:</p><ul><li><code>@Target({ METHOD, FIELD, ANNOTATION_TYPE })</code>: 表示此注解可以被用在方法, 字段或者 annotation 声明上</li><li><code>@Retention(RUNTIME)</code>: 表示这个注解信息是在运行期通过反射被读取的</li><li><code>@Constraint(validatedBy = ListValueConstraintValidator.class)</code>: 指明使用哪个校验器(类) 去校验使用了此注解的元素</li><li><code>@Documented</code>: 表示在对使用了该注解的类进行 javadoc 操作到时候, 这个注解会被添加到 javadoc 当中.</li></ul><h6 id="创建约束校验器" tabindex="-1"><a class="header-anchor" href="#创建约束校验器" aria-hidden="true">#</a> 创建约束校验器</h6><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ListValueConstraintValidator</span> <span class="token keyword">implements</span> <span class="token class-name">ConstraintValidator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ListValue</span><span class="token punctuation">,</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> set <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 初始化方法
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token class-name">ListValue</span> constraintAnnotation<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> vals <span class="token operator">=</span> constraintAnnotation<span class="token punctuation">.</span><span class="token function">vals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> val <span class="token operator">:</span> vals<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 判断是否校验成功
     *
     * <span class="token keyword">@param</span> <span class="token parameter">value</span> 需要校验的值
     * <span class="token keyword">@param</span> <span class="token parameter">context</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isValid</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> value<span class="token punctuation">,</span> <span class="token class-name">ConstraintValidatorContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">return</span> set<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>ListValueConstraintValidator</code> 定义了两个泛型参数, 第一个是这个校验器所服务到注解类型(即 <code>ListValue</code>), 第二个这个校验器所支持到被校验元素的类型 (即<code>Integer</code>)</p><p>如果一个注解支持多种类型的被校验元素的话, 那么需要为每个所支持的类型定义一个 <code>ConstraintValidator</code>, 并且注册到注解中</p><p>使用自定义注解:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@ListValue</span><span class="token punctuation">(</span> message <span class="token operator">=</span> <span class="token string">&quot;显示状态[0-不显示；1-显示]1&quot;</span> <span class="token punctuation">,</span> vals <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span> <span class="token punctuation">,</span> groups <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">Groups<span class="token punctuation">.</span>Add</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">,</span> <span class="token class-name">Groups<span class="token punctuation">.</span>Update</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">Integer</span> showStatus<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="属性分组" tabindex="-1"><a class="header-anchor" href="#属性分组" aria-hidden="true">#</a> 属性分组</h3><h4 id="接口文档" tabindex="-1"><a class="header-anchor" href="#接口文档" aria-hidden="true">#</a> 接口文档</h4><p>地址: <a href="https://easydoc.xyz/#/s/78237135" target="_blank" rel="noopener noreferrer">https://easydoc.xyz/#/s/78237135<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h4 id="分页查询动态参数" tabindex="-1"><a class="header-anchor" href="#分页查询动态参数" aria-hidden="true">#</a> 分页查询动态参数</h4><p>和传统分页区别不大</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// select * from pms_attr_group where catelog_id = ?</span>
<span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttrGroupEntity</span><span class="token punctuation">&gt;</span></span> wrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttrGroupEntity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;catelog_id&quot;</span><span class="token punctuation">,</span> catelogId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// and (attr_group_id = key or attr_group_name like %key%)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    wrapper<span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span>attrGroupDTOQueryWrapper <span class="token operator">-&gt;</span> attrGroupDTOQueryWrapper
            <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;attr_group_id&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">like</span><span class="token punctuation">(</span><span class="token string">&quot;attr_group_name&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="排除-bean-的空属性" tabindex="-1"><a class="header-anchor" href="#排除-bean-的空属性" aria-hidden="true">#</a> 排除 bean 的空属性</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@JsonInclude</span><span class="token punctuation">(</span><span class="token class-name">JsonInclude<span class="token punctuation">.</span>Include</span><span class="token punctuation">.</span><span class="token constant">NON_EMPTY</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;子节点&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryDTO</span><span class="token punctuation">&gt;</span></span> children<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="递归获取父节点" tabindex="-1"><a class="header-anchor" href="#递归获取父节点" aria-hidden="true">#</a> 递归获取父节点</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">findCatelogPath</span><span class="token punctuation">(</span><span class="token class-name">Long</span> catelogId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> longList <span class="token operator">=</span> <span class="token function">findParents</span><span class="token punctuation">(</span>catelogId<span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// list 强转 array</span>
    <span class="token keyword">return</span> longList<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">findParents</span><span class="token punctuation">(</span><span class="token class-name">Long</span> catelogId<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span>  list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 搜集当前节点id</span>
    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>catelogId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">CategoryDTO</span> byId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>catelogId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>byId<span class="token punctuation">.</span><span class="token function">getParentCid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">findParents</span><span class="token punctuation">(</span>byId<span class="token punctuation">.</span><span class="token function">getParentCid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> list<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="多对多的数据同步" tabindex="-1"><a class="header-anchor" href="#多对多的数据同步" aria-hidden="true">#</a> 多对多的数据同步</h4><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211241950232.png" alt="image-20221124195046906"></p><p>利用数据表的冗余字段来避免多对多的低效率关联查询</p><p><code>pms_category_brand_relation</code> 中的数据只能是 <code>pms_category</code> 和 <code>pms_brand</code> 中已经有的</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveDetails</span><span class="token punctuation">(</span><span class="token class-name">CategoryBrandRelationDTO</span> dto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Long</span> brandId <span class="token operator">=</span> dto<span class="token punctuation">.</span><span class="token function">getBrandId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Long</span> catelogId <span class="token operator">=</span> dto<span class="token punctuation">.</span><span class="token function">getCatelogId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">BrandEntity</span> brand <span class="token operator">=</span> brandDao<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>brandId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">CategoryEntity</span> category <span class="token operator">=</span> categoryDao<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>catelogId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    dto<span class="token punctuation">.</span><span class="token function">setBrandName</span><span class="token punctuation">(</span>brand<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dto<span class="token punctuation">.</span><span class="token function">setCatelogName</span><span class="token punctuation">(</span>category<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>dto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>pms_brand</code> 中的数据更新时需要同步更新中间表的数据</p><p><code>BrandServiceImpl</code>:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateDetail</span><span class="token punctuation">(</span><span class="token class-name">BrandDTO</span> dto<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 更新商品信息</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>dto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 更新中间表</span>
        categoryBrandRelationService<span class="token punctuation">.</span><span class="token function">updateBrand</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getBrandId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dto<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//todo 其他关联表</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>CategoryBrandRelationServiceImpl</code>:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateBrand</span><span class="token punctuation">(</span><span class="token class-name">Long</span> brandId<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">CategoryBrandRelationDTO</span> categoryBrandRelationDTO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CategoryBrandRelationDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">CategoryBrandRelationEntity</span> categoryBrandRelationEntity <span class="token operator">=</span> <span class="token class-name">ConvertUtils</span><span class="token punctuation">.</span><span class="token function">sourceToTarget</span><span class="token punctuation">(</span>categoryBrandRelationDTO<span class="token punctuation">,</span> <span class="token function">currentModelClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">UpdateWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryBrandRelationEntity</span><span class="token punctuation">&gt;</span></span> updateWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpdateWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    updateWrapper<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;brand_name&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;brand_id&quot;</span><span class="token punctuation">,</span> brandId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">update</span><span class="token punctuation">(</span>categoryBrandRelationEntity<span class="token punctuation">,</span> updateWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>pms_category_brand_relation</code> 中的数据更新时需要同步更新 <code>pms_category</code></p><p><code>CategoryBrandRelationServiceImpl</code>:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateDetails</span><span class="token punctuation">(</span><span class="token class-name">CategoryBrandRelationDTO</span> dto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">update</span><span class="token punctuation">(</span>dto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">CategoryEntity</span> category <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CategoryEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">UpdateWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> updateWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpdateWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    updateWrapper<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> dto<span class="token punctuation">.</span><span class="token function">getCatelogName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;cat_id&quot;</span><span class="token punctuation">,</span> dto<span class="token punctuation">.</span><span class="token function">getCatelogId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    categoryDao<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>category<span class="token punctuation">,</span> updateWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>pms_category</code> 中的数据更新时需要同步更新 <code>pms_category_brand_relation</code></p><p><code>CategoryServiceImpl</code>:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateCascade</span><span class="token punctuation">(</span><span class="token class-name">CategoryDTO</span> dto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">update</span><span class="token punctuation">(</span>dto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    categoryBrandRelationService<span class="token punctuation">.</span><span class="token function">updateCategory</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dto<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>CategoryBrandRelationServiceImpl</code>:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateCategory</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">Long</span> catId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    baseDao<span class="token punctuation">.</span><span class="token function">updateCategory</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> catId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>CategoryBrandRelationDao</code>:</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>update</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>updateCategory<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    update pms.pms_category_brand_relation set catelog_name = #{name} where catelog_id = #{catId}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>update</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="新增商品" tabindex="-1"><a class="header-anchor" href="#新增商品" aria-hidden="true">#</a> 新增商品</h3><h4 id="远程调用优惠券模块" tabindex="-1"><a class="header-anchor" href="#远程调用优惠券模块" aria-hidden="true">#</a> 远程调用优惠券模块</h4><p>在 <code>product</code> 模块的启动类上添加注解 <code>@EnableFeignClients</code> 开启远程调用</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">&quot;io.renren.feign&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProductApplication</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ProductApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编写调用接口</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">&quot;coupon&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CouponFeignService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;coupon/smscoupon&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">Result</span> <span class="token function">saveSpuBounds</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">SpuInfoDTO</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过 <code>@FeignClient(&quot;coupon&quot;)</code> 去 nacos 找到 <code>coupon</code> 服务, 并发送 <code>@PostMapping(&quot;coupon/smscoupon&quot;)</code> 请求, 请求将 <code>SpuInfoDTO</code> 自动转换为 <code>json</code> 对象作为请求体传输, 也就是说 <code>coupon</code> 服务在接收时不需要一定是 <code>SpuInfoDTO</code> 对象, 只要能兼容就行</p><blockquote><ul><li>服务名称：coupon</li><li>请求方式：Post</li><li>请求路径：coupon/smscoupon</li><li>请求参数：SpuInfoDTO data</li><li>返回值类型：Result</li></ul></blockquote><h2 id="elasticsearch-8" tabindex="-1"><a class="header-anchor" href="#elasticsearch-8" aria-hidden="true">#</a> ElasticSearch 8</h2><blockquote><p>ElasticSearch, kibana, ik 分词器三者版本必须统一!</p></blockquote><p>官方文档:</p><p><a href="https://www.elastic.co/guide/en/elasticsearch/client/java-api-client/7.16/introduction.html#introduction" target="_blank" rel="noopener noreferrer">https://www.elastic.co/guide/en/elasticsearch/client/java-api-client/7.16/introduction.html#introduction<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="环境准备" tabindex="-1"><a class="header-anchor" href="#环境准备" aria-hidden="true">#</a> 环境准备</h3><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--排除springboot默认的版本, 防止依赖冲突--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>elasticsearch.version</span><span class="token punctuation">&gt;</span></span>8.5.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>elasticsearch.version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>co.elastic.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>elasticsearch-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>8.5.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>jakarta.json<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jakarta.json-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.0.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.fasterxml.jackson.core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jackson-databind<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.12.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置文件</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">search.http_host</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.202.100</span>
<span class="token key attr-name">search.http_port</span><span class="token punctuation">=</span><span class="token value attr-value">9200</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>自动装配</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${search.http_host}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> searchHost<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${search.http_port}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ElasticsearchClient</span> <span class="token function">configClint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Create the low-level client</span>
        <span class="token class-name">RestClient</span> restClient <span class="token operator">=</span> <span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">HttpHost</span><span class="token punctuation">(</span>searchHost<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Create the transport with a Jackson mapper</span>
        <span class="token class-name">ElasticsearchTransport</span> transport <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestClientTransport</span><span class="token punctuation">(</span>
                restClient<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">JacksonJsonpMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// And create the API client</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ElasticsearchClient</span><span class="token punctuation">(</span>transport<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>准备一个实体类</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Product</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> sku<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> price<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="建立索引" tabindex="-1"><a class="header-anchor" href="#建立索引" aria-hidden="true">#</a> 建立索引</h3><p><a href="https://www.elastic.co/guide/en/elasticsearch/client/java-api-client/current/indexing.html#indexing" target="_blank" rel="noopener noreferrer">单对象建立索引<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><blockquote><p>重复插入会覆盖相同 id 的数据</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchConfigTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ElasticsearchClient</span> client<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createHotelIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 方法1 DSL</span>
        <span class="token class-name">Product</span> product <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Product</span><span class="token punctuation">(</span><span class="token string">&quot;bk-1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;City bike&quot;</span><span class="token punctuation">,</span> <span class="token number">123.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">IndexResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> i
                <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>product<span class="token punctuation">.</span><span class="token function">getSku</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">document</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Indexed with version: {}&quot;</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// ======================================================================</span>

        <span class="token comment">// 方法2 使用 IndexRequest</span>
        <span class="token class-name">Product</span> product2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Product</span><span class="token punctuation">(</span><span class="token string">&quot;bk-2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;City bike2&quot;</span><span class="token punctuation">,</span> <span class="token number">1230.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">IndexRequest</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> request <span class="token operator">=</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> i
                <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>product2<span class="token punctuation">.</span><span class="token function">getSku</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">document</span><span class="token punctuation">(</span>product2<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">IndexResponse</span> response2 <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>

        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Indexed with version: {}&quot;</span><span class="token punctuation">,</span> response2<span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// =========================================================================</span>

        <span class="token comment">// 方法3 使用 构造器</span>
        <span class="token class-name">Product</span> product3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Product</span><span class="token punctuation">(</span><span class="token string">&quot;bk-3&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;City bike3&quot;</span><span class="token punctuation">,</span> <span class="token number">1233.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">IndexRequest<span class="token punctuation">.</span>Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> indexReqBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest<span class="token punctuation">.</span>Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        indexReqBuilder<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;product3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        indexReqBuilder<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>product3<span class="token punctuation">.</span><span class="token function">getSku</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        indexReqBuilder<span class="token punctuation">.</span><span class="token function">document</span><span class="token punctuation">(</span>product3<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">IndexResponse</span> response3 <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>indexReqBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Indexed with version: {}&quot;</span><span class="token punctuation">,</span> response3<span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 操作 json</span>
        <span class="token class-name">Reader</span> input <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringReader</span><span class="token punctuation">(</span>
                <span class="token string">&quot;{&#39;@timestamp&#39;: &#39;2022-04-08T13:55:32Z&#39;, &#39;level&#39;: &#39;warn&#39;, &#39;message&#39;: &#39;Some log message&#39;}&quot;</span>
                        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token char">&#39;\&#39;&#39;</span><span class="token punctuation">,</span> <span class="token char">&#39;&quot;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">IndexRequest</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JsonData</span><span class="token punctuation">&gt;</span></span> request2 <span class="token operator">=</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> i
                <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;logs&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withJson</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">IndexResponse</span> response4 <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>request2<span class="token punctuation">)</span><span class="token punctuation">;</span>

        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Indexed with version: {}&quot;</span><span class="token punctuation">,</span> response4<span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><a href="https://www.elastic.co/guide/en/elasticsearch/client/java-api-client/current/indexing-bulk.html#indexing-bulk" target="_blank" rel="noopener noreferrer">批量建立索引<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchConfigTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ElasticsearchClient</span> client<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createHotelIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> products <span class="token operator">=</span> <span class="token function">fetchProducts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">BulkRequest<span class="token punctuation">.</span>Builder</span> br <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BulkRequest<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Product</span> product5 <span class="token operator">:</span> products<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            br<span class="token punctuation">.</span><span class="token function">operations</span><span class="token punctuation">(</span>op <span class="token operator">-&gt;</span> op                <span class="token comment">//[1]</span>
                    <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>idx <span class="token operator">-&gt;</span> idx             <span class="token comment">//[2]</span>
                            <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span>    <span class="token comment">//[3]</span>
                            <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>product5<span class="token punctuation">.</span><span class="token function">getSku</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">document</span><span class="token punctuation">(</span>product5<span class="token punctuation">)</span>
                    <span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 允许在单个请求中执行多个索引/更新/删除操作。</span>
        <span class="token class-name">BulkResponse</span> result <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">bulk</span><span class="token punctuation">(</span>br<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Log errors, if any</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">errors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Bulk had errors&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BulkResponseItem</span> item <span class="token operator">:</span> result<span class="token punctuation">.</span><span class="token function">items</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reason</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 操作 json</span>
        <span class="token class-name">Reader</span> input2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringReader</span><span class="token punctuation">(</span>
                <span class="token string">&quot;{&#39;@timestamp&#39;: &#39;2022-04-08T13:55:32Z&#39;, &#39;level&#39;: &#39;warn&#39;, &#39;message&#39;: &#39;Some log message&#39;}&quot;</span>
                        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token char">&#39;\&#39;&#39;</span><span class="token punctuation">,</span> <span class="token char">&#39;&quot;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Reader</span> input3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringReader</span><span class="token punctuation">(</span>
        <span class="token string">&quot;{&#39;@timestamp&#39;: &#39;2022-04-08T13:55:32Z&#39;, &#39;level&#39;: &#39;warn&#39;, &#39;message&#39;: &#39;Some log message&#39;}&quot;</span>
                <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token char">&#39;\&#39;&#39;</span><span class="token punctuation">,</span> <span class="token char">&#39;&quot;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">JsonpMapper</span> jsonpMapper <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">_transport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">jsonpMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JsonProvider</span> jsonProvider <span class="token operator">=</span> jsonpMapper<span class="token punctuation">.</span><span class="token function">jsonProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JsonData</span><span class="token punctuation">&gt;</span></span> jsonData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jsonData<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">JsonData</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>jsonProvider<span class="token punctuation">.</span><span class="token function">createParser</span><span class="token punctuation">(</span>input2<span class="token punctuation">)</span><span class="token punctuation">,</span> jsonpMapper<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jsonData<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">JsonData</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>jsonProvider<span class="token punctuation">.</span><span class="token function">createParser</span><span class="token punctuation">(</span>input3<span class="token punctuation">)</span><span class="token punctuation">,</span> jsonpMapper<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">BulkRequest<span class="token punctuation">.</span>Builder</span> br2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BulkRequest<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        jsonData<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>j <span class="token operator">-&gt;</span> br2<span class="token punctuation">.</span><span class="token function">operations</span><span class="token punctuation">(</span>op <span class="token operator">-&gt;</span> op
                <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>idx <span class="token operator">-&gt;</span> idx
                        <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;logs&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">document</span><span class="token punctuation">(</span>jsonData<span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li><p>[1] 将实体对象都添加到了 <code>operations</code> 集合中</p></li><li><p>[2] <code>ObjectBuilder</code>, 初始化 <code>Kind</code> 和 <code>value</code>, <code>kind</code> 是个枚举: <code>Index(&quot;index&quot;)</code>, <code>Create(&quot;create&quot;)</code>, <code>Update(&quot;update&quot;)</code>, <code>Delete(&quot;delete&quot;)</code>; value 是 <code>operation</code></p></li><li><p>[3] 类似于单个文档索引：索引名称、标识符和<a href="https://www.elastic.co/guide/en/elasticsearch/client/java-api-client/current/indexing.html" target="_blank" rel="noopener noreferrer">文档<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li></ol><blockquote><p>简单概述: 收集数据并统一封装好, 最终通过 <code>client.bulk</code> 一并提交, <code>bulk()</code> 允许在单个请求中执行多个索引/更新/删除操作</p><p>该方法也能建立单索引</p></blockquote><h3 id="按-id-读取" tabindex="-1"><a class="header-anchor" href="#按-id-读取" aria-hidden="true">#</a> 按 ID 读取</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

    <span class="token class-name">GetResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> response6 <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>g <span class="token operator">-&gt;</span> g
                    <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span>  <span class="token comment">// [1]</span>
                    <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">&quot;bk-1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token keyword">class</span>               <span class="token comment">// [2]</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>response6<span class="token punctuation">.</span><span class="token function">found</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Product</span> product5 <span class="token operator">=</span> response6<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Product name &quot;</span> <span class="token operator">+</span> product5<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span>info <span class="token punctuation">(</span><span class="token string">&quot;Product not found&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// =========================================================</span>

    <span class="token comment">// json 对象</span>
     <span class="token class-name">GetResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ObjectNode</span><span class="token punctuation">&gt;</span></span> response7 <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>g <span class="token operator">-&gt;</span> g
                    <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">&quot;bk-2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">ObjectNode</span><span class="token punctuation">.</span><span class="token keyword">class</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>response7<span class="token punctuation">.</span><span class="token function">found</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ObjectNode</span> json <span class="token operator">=</span> response7<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Product name &quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Product not found&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>[1] 目标索引</li><li>[2] 实体类</li></ol><h3 id="搜索" tabindex="-1"><a class="header-anchor" href="#搜索" aria-hidden="true">#</a> 搜索</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">String</span> searchText <span class="token operator">=</span> <span class="token string">&quot;bike&quot;</span><span class="token punctuation">;</span>

<span class="token class-name">SearchResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> esClient<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> s
    <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>q <span class="token operator">-&gt;</span> q
        <span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>t <span class="token operator">-&gt;</span> t
            <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>searchText<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token keyword">class</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">TotalHits</span> total <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">total</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">boolean</span> isExactResult <span class="token operator">=</span> total<span class="token punctuation">.</span><span class="token function">relation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TotalHitsRelation<span class="token punctuation">.</span>Eq</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>isExactResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;There are &quot;</span> <span class="token operator">+</span> total<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; results&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;There are more than &quot;</span> <span class="token operator">+</span> total<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; results&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Hit</span><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> hits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Hit</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> hit<span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Product</span> product <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Found product &quot;</span> <span class="token operator">+</span> product<span class="token punctuation">.</span><span class="token function">getSku</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, score &quot;</span> <span class="token operator">+</span> hit<span class="token punctuation">.</span><span class="token function">score</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>多条件搜索</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">String</span> searchText <span class="token operator">=</span> <span class="token string">&quot;bike&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> maxPrice <span class="token operator">=</span> <span class="token number">200.0</span><span class="token punctuation">;</span>

<span class="token comment">// Search by product name</span>
<span class="token class-name">Query</span> byName <span class="token operator">=</span> <span class="token class-name">MatchQuery</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>m <span class="token operator">-&gt;</span> m
    <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>searchText<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">_toQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Search by max price</span>
<span class="token class-name">Query</span> byMaxPrice <span class="token operator">=</span> <span class="token class-name">RangeQuery</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> r
    <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span><span class="token class-name">JsonData</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>maxPrice<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">_toQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Combine name and price queries to search the product index</span>
<span class="token class-name">SearchResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> esClient<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> s
    <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>q <span class="token operator">-&gt;</span> q
        <span class="token punctuation">.</span><span class="token function">bool</span><span class="token punctuation">(</span>b <span class="token operator">-&gt;</span> b
            <span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span>byName<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span>byMaxPrice<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token keyword">class</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Hit</span><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> hits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Hit</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> hit<span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Product</span> product <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Found product &quot;</span> <span class="token operator">+</span> product<span class="token punctuation">.</span><span class="token function">getSku</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, score &quot;</span> <span class="token operator">+</span> hit<span class="token punctuation">.</span><span class="token function">score</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="聚合" tabindex="-1"><a class="header-anchor" href="#聚合" aria-hidden="true">#</a> 聚合</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">String</span> searchText <span class="token operator">=</span> <span class="token string">&quot;bike&quot;</span><span class="token punctuation">;</span>

<span class="token class-name">Query</span> query <span class="token operator">=</span> <span class="token class-name">MatchQuery</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>m <span class="token operator">-&gt;</span> m
        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>searchText<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">_toQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">SearchResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>b <span class="token operator">-&gt;</span> b
                <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">aggregations</span><span class="token punctuation">(</span><span class="token string">&quot;sku&quot;</span><span class="token punctuation">,</span> a <span class="token operator">-&gt;</span> a
                        <span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span>h <span class="token operator">-&gt;</span> h
                                <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;sku.keyword&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token keyword">class</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StringTermsBucket</span><span class="token punctuation">&gt;</span></span> buckets <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">aggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;sku&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">sterms</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">buckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StringTermsBucket</span> bucket<span class="token operator">:</span> buckets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;There are &quot;</span> <span class="token operator">+</span> bucket<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">_toJsonString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应的 DSL</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>GET /products/_search
<span class="token punctuation">{</span>
  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bike&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span>
  <span class="token property">&quot;aggs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;sku&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;terms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sku.keyword&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>field 除了一些特定字段(如颜色)支持字符串检索外, 其他字段默认不支持, 检索不支持的字段会得到一个异常提醒:</p><p><code>&quot;Fielddata is disabled on [sku] in [products]. Text fields are not optimised for operations that require per-document field data like aggregations and sorting, so these operations are disabled by default. Please use a keyword field instead. Alternatively, set fielddata=true on [sku] in order to load field data by uninverting the inverted index. Note that this can use significant memory.&quot;</code></p><p>可以使用 <code>put</code> 设置 <code>fielddata=true</code> 或者使用 <code>VALUE.keyword</code>, 一般推荐使用后者</p></blockquote><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token comment">// 全局</span>
PUT /products/_mapping
<span class="token punctuation">{</span>
  <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;sku&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;fielddata&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 具体某个字段, 只设置具体某个字段依旧会抛异常~~~</span>
PUT /products/_doc/bk<span class="token number">-1</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;sku&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;fielddata&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="检索业务" tabindex="-1"><a class="header-anchor" href="#检索业务" aria-hidden="true">#</a> 检索业务</h2><h3 id="分析" tabindex="-1"><a class="header-anchor" href="#分析" aria-hidden="true">#</a> 分析</h3><h4 id="存储商品的什么信息到-es-中" tabindex="-1"><a class="header-anchor" href="#存储商品的什么信息到-es-中" aria-hidden="true">#</a> 存储商品的什么信息到 es 中</h4><ol><li><p>需要保存 sku 信息</p><ul><li>当搜索商品名时，查询的是 sku 的标题 sku_title；</li><li>可能通过 sku 的标题、销量、价格区间检索</li></ul></li><li><p>需要保存品牌、分类等信息</p><ul><li>点击分类，检索分类下的所有信息</li><li>点击品牌，检索品牌下的商品信息</li></ul></li><li><p>需要保存 spu 信息</p><ul><li>选择规格，检索共有这些规格的商品</li></ul></li></ol><h4 id="怎么设计存储结构来保存数据" tabindex="-1"><a class="header-anchor" href="#怎么设计存储结构来保存数据" aria-hidden="true">#</a> 怎么设计存储结构来保存数据</h4><p>方案 1-空间换时间</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    skuId<span class="token operator">:</span><span class="token number">1</span>
    spuId<span class="token operator">:</span><span class="token number">11</span>
    skyTitile<span class="token operator">:</span>华为xx
    price<span class="token operator">:</span><span class="token number">999</span>
    saleCount<span class="token operator">:</span><span class="token number">9</span>
    attrs<span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span>尺寸<span class="token operator">:</span><span class="token number">5</span>存<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>CPU<span class="token operator">:</span>高通<span class="token number">945</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>分辨率<span class="token operator">:</span>全高清<span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
# 缺点：会产生冗余字段，对于相同类型的商品，attrs 属性字段会重复，空间占用大
# 好处：方便检索
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>方案 2-时间换空间</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>sku索引
<span class="token punctuation">{</span>
    skuId<span class="token operator">:</span><span class="token number">1</span>
    spuId<span class="token operator">:</span><span class="token number">11</span>
<span class="token punctuation">}</span>
attr索引
<span class="token punctuation">{</span>
    spuId<span class="token operator">:</span><span class="token number">11</span>
    attrs<span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span>尺寸<span class="token operator">:</span><span class="token number">5</span>寸<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>CPU<span class="token operator">:</span>高通<span class="token number">945</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>分辨率<span class="token operator">:</span>全高清<span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
# 缺点：选择公共属性attr时<span class="token punctuation">,</span>会检索当前属性的所有商品分类，然后再查询当前商品分类的所有可能属性；导致耗时长。
# 好处：空间利用率高
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="最终方案-存储结构" tabindex="-1"><a class="header-anchor" href="#最终方案-存储结构" aria-hidden="true">#</a> 最终方案-存储结构</h3><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code>PUT product
<span class="token punctuation">{</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;skuId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;spuId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;skuPrice&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;skuImg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">&quot;doc_values&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;saleCount&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;long&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;hasStock&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;boolean&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;hotScore&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;brandId&quot;</span><span class="token operator">:</span>  <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;catalogId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;brandName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">&quot;doc_values&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;brandImg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">&quot;doc_values&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;catalogName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">&quot;doc_values&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;attrs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nested&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;attrId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;attrName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token property">&quot;doc_values&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">&quot;attrValue&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>mapping 结构字段说明：</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;skuId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;spuId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> # 精确检索，不分词
    <span class="token property">&quot;skuTitle&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span> # 全文检索
      <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span> # 分词器
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;skuPrice&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;skuImg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> # <span class="token boolean">false</span> 不可被检索
      <span class="token property">&quot;doc_values&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span> # <span class="token boolean">false</span> 不可被聚合
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;saleCount&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;long&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> # 商品销量
    <span class="token property">&quot;hasStock&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;boolean&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> # 商品是否有库存
    <span class="token property">&quot;hotScore&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> # 商品热度评分
    <span class="token property">&quot;brandId&quot;</span><span class="token operator">:</span>  <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> # 品牌id
    <span class="token property">&quot;catalogId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> # 分类id
    <span class="token property">&quot;brandName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>  # 品牌名，只用来查看，不用来检索和聚合
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token property">&quot;doc_values&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;brandImg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>    # 品牌图片，只用来查看，不用来检索和聚合
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token property">&quot;doc_values&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;catalogName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>    # 分类名，只用来查看，不用来检索和聚合
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token property">&quot;doc_values&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;attrs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>  # 属性对象
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nested&quot;</span><span class="token punctuation">,</span> # 嵌入式，内部属性
      <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;attrId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;attrName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>   # 属性名
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token property">&quot;doc_values&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;attrValue&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span> <span class="token punctuation">}</span>  # 属性值
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="关于-nested-类型" tabindex="-1"><a class="header-anchor" href="#关于-nested-类型" aria-hidden="true">#</a> 关于 nested 类型</h4><p>官网：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/nested.html" target="_blank" rel="noopener noreferrer">Nested field type<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><ul><li>Object 数据类型的数组会被扁平化处理为一个简单的键与值的列表，即对象的相同属性会放到同一个数组中，在检索时会出现错误。参考官网：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/nested.html#nested-arrays-flattening-objects" target="_blank" rel="noopener noreferrer">How arrays of objects are flattened<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li>对于 Object 类型的数组，要使用 nested 字段类型。参考官网：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/nested.html#nested-fields-array-objects" target="_blank" rel="noopener noreferrer">Using nested fields for arrays of objects<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><h2 id="商品上架" tabindex="-1"><a class="header-anchor" href="#商品上架" aria-hidden="true">#</a> 商品上架</h2><p>es 实体类, 建议放在 common 包下</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SkuEsModel</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> spuId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> skuTitle<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> skuPrice<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> skuImg<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> saleCount<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 是否有库存
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> hasStock<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 热度
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> hotScore<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> brandId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> catalogId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> brandName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> brandImg<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> catalogName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Attrs</span><span class="token punctuation">&gt;</span></span> attrs<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Data</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Attrs</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">Long</span> attrId<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> attrName<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> attrValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>整体流程</p><blockquote><ol><li>查出当前 spuId 对应的所有 sku 信息,品牌的名字</li><li>查出当前 sku 的所有<strong>可以被用来检索</strong>的规格属性</li><li>发送远程调用，库存系统查询是否有库存</li><li>封装每个 sku 的信息(数据, 库存信息, 热度评分...)</li><li>将数据发给 es 进行保存</li><li>修改当前 spu 的状态</li><li>远程调用失败问题处理(重复调用, 接口幂等性:重试机制)</li></ol></blockquote><div class="custom-container tip"><p class="custom-container-title">提示</p><p>feign 远程调用时如果出现参数不匹配, NPE, 调用的注册信息(如地址)写错, 或者远程方法存在异常, 均会出现 <code>feign.FeignException: status 500 reading</code>, 而且没有其它提示!</p></div><h2 id="性能优化" tabindex="-1"><a class="header-anchor" href="#性能优化" aria-hidden="true">#</a> 性能优化</h2><h3 id="nginx-代理" tabindex="-1"><a class="header-anchor" href="#nginx-代理" aria-hidden="true">#</a> nginx 代理</h3><p><a href="https://cloud.tencent.com/developer/article/1418457" target="_blank" rel="noopener noreferrer">终于有人把正向代理和反向代理解释的明明白白了！ - 腾讯云开发者社区-腾讯云 (tencent.com)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h4 id="正向代理" tabindex="-1"><a class="header-anchor" href="#正向代理" aria-hidden="true">#</a> 正向代理</h4><p><strong>&quot;代理服务器&quot;代理了&quot;客户端&quot;，去和&quot;目标服务器&quot;进行交互。</strong></p><p>有时候，用户想要访问某国外网站，该网站无法在国内直接访问，但是我们可以访问到一个代理服务器，这个代理服务器可以访问到这个国外网站。这样呢，用户对该国外网站的访问就需要通过代理服务器来转发请求，并且该代理服务器也会将请求的响应再返回给用户。这个上网的过程就是用到了正向代理。</p><h4 id="方向代理" tabindex="-1"><a class="header-anchor" href="#方向代理" aria-hidden="true">#</a> 方向代理</h4><p><strong>&quot;代理服务器&quot;代理了&quot;目标服务器&quot;，去和&quot;客户端&quot;进行交互。</strong></p><p>对于常用的场景，就是我们在Web开发中用到的<a href="https://cloud.tencent.com/product/clb?from=10680" target="_blank" rel="noopener noreferrer">负载均衡<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>服务器，客户端发送请求到负载均衡服务器上，负载均衡服务器再把请求转发给一台真正的服务器来执行，再把执行结果返回给客户端。</p><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202212011012772.png" alt="image-20221201100756300"></p><h4 id="nginx-配置文件" tabindex="-1"><a class="header-anchor" href="#nginx-配置文件" aria-hidden="true">#</a> nginx 配置文件</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>user  nginx<span class="token punctuation">;</span>
worker_processes  <span class="token number">1</span><span class="token punctuation">;</span>

error_log  /var/log/nginx/error.log warn<span class="token punctuation">;</span>
pid        /var/run/nginx.pid<span class="token punctuation">;</span>

events <span class="token punctuation">{</span>
    worker_connections  <span class="token number">1024</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

http <span class="token punctuation">{</span>
    include       /etc/nginx/mime.types<span class="token punctuation">;</span>
    default_type  application/octet-stream<span class="token punctuation">;</span>

    log_format  main  <span class="token string">&#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span>
                      <span class="token string">&#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span>
                      <span class="token string">&#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;</span><span class="token punctuation">;</span>

    access_log  /var/log/nginx/access.log  main<span class="token punctuation">;</span>

    sendfile        on<span class="token punctuation">;</span>
    <span class="token comment">#tcp_nopush     on;</span>

    keepalive_timeout  <span class="token number">65</span><span class="token punctuation">;</span>

    <span class="token comment">#gzip  on;</span>

    include /etc/nginx/conf.d/*.conf<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202212011012232.png" alt="image-20221201101008965"></p><p>在 http 块中最后有 include /etc/nginx/conf.d/*.conf; 这句配置说明在 conf.d 目录下所有 .conf 后缀的文件内容都会作为 nginx 配置文件 http 块中的配置</p><p>这是为了防止主配置文件太复杂，也可以对不同的配置进行分类</p><h3 id="nginx-反向代理" tabindex="-1"><a class="header-anchor" href="#nginx-反向代理" aria-hidden="true">#</a> nginx 反向代理</h3><p>修改 Windows hosts 文件</p><p>位置：C:\Windows\System32\drivers\etc</p><p>在后面追加以下内容</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># nginx ip      # 域名映射</span>
<span class="token number">192.168</span>.202.100 gulimall.com
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>nginx.conf upstream 配置上游服务器为网关地址</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>user  nginx<span class="token punctuation">;</span>
worker_processes  <span class="token number">1</span><span class="token punctuation">;</span>

error_log  /var/log/nginx/error.log warn<span class="token punctuation">;</span>
pid        /var/run/nginx.pid<span class="token punctuation">;</span>

events <span class="token punctuation">{</span>
    worker_connections  <span class="token number">1024</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

http <span class="token punctuation">{</span>
    include       /etc/nginx/mime.types<span class="token punctuation">;</span>
    default_type  application/octet-stream<span class="token punctuation">;</span>

    log_format  main  <span class="token string">&#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span>
                      <span class="token string">&#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span>
                      <span class="token string">&#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;</span><span class="token punctuation">;</span>

    access_log  /var/log/nginx/access.log  main<span class="token punctuation">;</span>

    sendfile        on<span class="token punctuation">;</span>
    <span class="token comment">#tcp_nopush     on;</span>

    keepalive_timeout  <span class="token number">65</span><span class="token punctuation">;</span>

    <span class="token comment">#gzip  on;</span>
    upstream gulimall <span class="token punctuation">{</span>
        server <span class="token number">192.168</span>.137.110:88<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    include /etc/nginx/conf.d/*.conf<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 conf.d 下复制 default.conf 并改名为 gulimall.conf, 添加配置</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>server <span class="token punctuation">{</span>
    listen       <span class="token number">80</span><span class="token punctuation">;</span>
    server_name  gulimall.com<span class="token punctuation">;</span>

    <span class="token comment">#charset koi8-r;</span>
    <span class="token comment">#access_log  /var/log/nginx/log/host.access.log  main;</span>

    location / <span class="token punctuation">{</span>
      proxy_set_header Host <span class="token variable">$host</span><span class="token punctuation">;</span>
      proxy_pass http://gulimall<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">#error_page  404              /404.html;</span>

    <span class="token comment"># redirect server error pages to the static page /50x.html</span>
    <span class="token comment">#</span>
    error_page   <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span>  /50x.html<span class="token punctuation">;</span>
    location <span class="token operator">=</span> /50x.html <span class="token punctuation">{</span>
        root   /usr/share/nginx/html<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>添加网关路由(需要放到最后, 防止覆盖其它路由)</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
		  <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gulimall
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//product
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Host=<span class="token important">**.gulimall.com</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>gulimall.com -&gt; 192.168.202.100 -&gt; gulimall.conf -&gt; nginx.conf -&gt; gateway -&gt; product</p><ol><li>根据 hosts 文件的配置，请求 <code>gulimall.com</code> 域名时会指向虚拟机 ip: <code>192.168.202.100</code></li><li>当请求到 <code>192.168.202.100:80</code> 时，会被 nginx 转发到我们配置的 <code>proxy_pass http://gulimall</code></li><li><code>http://gulimall</code> 指向上游路径: <code>192.168.137.110:88</code>, 并通过 <code>proxy_set_header Host $host</code> 保留 host 地址</li><li>网关通过 <code>Host=**.gulimall.com</code> 接收请求, 并路由到 <code>lb://product</code></li></ol></blockquote><h3 id="nginx-动静分离" tabindex="-1"><a class="header-anchor" href="#nginx-动静分离" aria-hidden="true">#</a> nginx 动静分离</h3><p>把商品服务中静态文件夹 static 放到 nginx 下 index.html 所在的目录</p><p>查看所有数据卷</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> volume <span class="token function">ls</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>查看 html 数据卷详细信息, 得到挂载地址</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> volume inspect html
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/image-20210731173809877.png" alt="image-20210731173809877"></p><p>将静态资源存放进去</p><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202212012009871.png" alt="image-20221201200958803"></p><p>修改 nginx 配置文件 gulimall.conf</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># /static/ 下所有的请求都转给 nginx</span>
location /static/ <span class="token punctuation">{</span>
<span class="token comment"># nginx中 index.html 在容器中的真实目录</span>
	root /usr/share/nginx/html<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启 nginx</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> restart nginx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="优化查询三级分类数据" tabindex="-1"><a class="header-anchor" href="#优化查询三级分类数据" aria-hidden="true">#</a> 优化查询三级分类数据</h3><p>避免多次(循环)查询数据库</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catalogs2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCatalogJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;查询了数据库&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 性能优化：将数据库的多次查询变为一次</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> selectList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//1、查出所有分类</span>
    <span class="token comment">//1、1）查出所有一级分类</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> level1Categories <span class="token operator">=</span> <span class="token function">getParentCid</span><span class="token punctuation">(</span>selectList<span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//封装数据</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catalogs2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> parentCid <span class="token operator">=</span> level1Categories<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span>k <span class="token operator">-&gt;</span> k<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//1、每一个的一级分类,查到这个一级分类的二级分类</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> categoryEntities <span class="token operator">=</span> <span class="token function">getParentCid</span><span class="token punctuation">(</span>selectList<span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2、封装上面的结果</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Catalogs2Vo</span><span class="token punctuation">&gt;</span></span> catalogs2Vos <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>categoryEntities <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            catalogs2Vos <span class="token operator">=</span> categoryEntities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>l2 <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">Catalogs2Vo</span> catalogs2Vo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Catalogs2Vo</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> l2<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l2<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//1、找当前二级分类的三级分类封装成vo</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> level3Catelog <span class="token operator">=</span> <span class="token function">getParentCid</span><span class="token punctuation">(</span>selectList<span class="token punctuation">,</span> l2<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>level3Catelog <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Catalogs2Vo<span class="token punctuation">.</span>Category3Vo</span><span class="token punctuation">&gt;</span></span> category3Vos <span class="token operator">=</span> level3Catelog<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>l3 <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                        <span class="token comment">//2、封装成指定格式</span>
                        <span class="token class-name">Catalogs2Vo<span class="token punctuation">.</span>Category3Vo</span> category3Vo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Catalogs2Vo<span class="token punctuation">.</span>Category3Vo</span><span class="token punctuation">(</span>l2<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l3<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l3<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">return</span> category3Vo<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    catalogs2Vo<span class="token punctuation">.</span><span class="token function">setCatalog3List</span><span class="token punctuation">(</span>category3Vos<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">return</span> catalogs2Vo<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> catalogs2Vos<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> parentCid<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">getParentCid</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> selectList<span class="token punctuation">,</span> <span class="token class-name">Long</span> parentCid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> selectList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> item<span class="token punctuation">.</span><span class="token function">getParentCid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>parentCid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="缓存和分布式锁" tabindex="-1"><a class="header-anchor" href="#缓存和分布式锁" aria-hidden="true">#</a> 缓存和分布式锁</h2><p>redis 依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!-- redis --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 39.<span class="token important">*.*.63</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> xiao.000
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>如果部署在云服务器一定要设置密码, 否则很容易变成矿机!</p></blockquote><div class="custom-container info"><p class="custom-container-title">相关信息</p><p>一次真实的被挖矿记录, 好在这 redis 是 docker 中的</p><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202212020917262.png" alt="image-20221202091716100"></p><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202212020917121.png" alt="image-20221202091740996"></p></div><h3 id="给业务中加入缓存" tabindex="-1"><a class="header-anchor" href="#给业务中加入缓存" aria-hidden="true">#</a> 给业务中加入缓存</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catalogs2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCatalogJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.从缓存中读取分类信息</span>
    <span class="token class-name">String</span> catalogJSON <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;catalogJSON&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>catalogJSON<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 2. 缓存中没有，查询数据库</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catalogs2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> catalogJsonFromDB <span class="token operator">=</span> <span class="token function">getCatalogJsonFromDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 查询到的数据存放到缓存中，将对象转成 JSON 存储</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;catalogJSON&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>catalogJsonFromDB<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> catalogJsonFromDB<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>catalogJSON<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catalogs2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * 加缓存前,只读取数据库的操作
 *
 * <span class="token keyword">@return</span>
 */</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catalogs2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCatalogJsonFromDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;查询了数据库&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 性能优化：将数据库的多次查询变为一次</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> selectList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//1、查出所有分类</span>
    <span class="token comment">//1、1）查出所有一级分类</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> level1Categories <span class="token operator">=</span> <span class="token function">getParentCid</span><span class="token punctuation">(</span>selectList<span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//封装数据</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catalogs2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> parentCid <span class="token operator">=</span> level1Categories<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span>k <span class="token operator">-&gt;</span> k<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//1、每一个的一级分类,查到这个一级分类的二级分类</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> categoryEntities <span class="token operator">=</span> <span class="token function">getParentCid</span><span class="token punctuation">(</span>selectList<span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2、封装上面的结果</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Catalogs2Vo</span><span class="token punctuation">&gt;</span></span> catalogs2Vos <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>categoryEntities <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            catalogs2Vos <span class="token operator">=</span> categoryEntities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>l2 <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">Catalogs2Vo</span> catalogs2Vo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Catalogs2Vo</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> l2<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l2<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//1、找当前二级分类的三级分类封装成vo</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">&gt;</span></span> level3Catelog <span class="token operator">=</span> <span class="token function">getParentCid</span><span class="token punctuation">(</span>selectList<span class="token punctuation">,</span> l2<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>level3Catelog <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Catalogs2Vo<span class="token punctuation">.</span>Category3Vo</span><span class="token punctuation">&gt;</span></span> category3Vos <span class="token operator">=</span> level3Catelog<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>l3 <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                        <span class="token comment">//2、封装成指定格式</span>
                        <span class="token class-name">Catalogs2Vo<span class="token punctuation">.</span>Category3Vo</span> category3Vo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Catalogs2Vo<span class="token punctuation">.</span>Category3Vo</span><span class="token punctuation">(</span>l2<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l3<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l3<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">return</span> category3Vo<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    catalogs2Vo<span class="token punctuation">.</span><span class="token function">setCatalog3List</span><span class="token punctuation">(</span>category3Vos<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">return</span> catalogs2Vo<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> catalogs2Vos<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> parentCid<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="堆外内存溢出异常" tabindex="-1"><a class="header-anchor" href="#堆外内存溢出异常" aria-hidden="true">#</a> 堆外内存溢出异常</h4><p>这里可能会产生堆外内存溢出异常：OutOfDirectMemoryError。</p><p>分析：</p><ul><li>SpringBoot 2.0 以后默认使用 lettuce 作为操作 redis 的客户端，它使用 netty 进行网络通信；</li><li>lettuce 的 bug 导致 netty 堆外内存溢出；</li><li>netty 如果没有指定堆外内存，默认使用 -Xmx 参数指定的内存；</li><li>可以通过 -Dio.netty.maxDirectMemory 进行设置；</li></ul><p>解决方案：不能只使用 -Dio.netty.maxDirectMemory 去调大堆外内存，这样只会延缓异常出现的时间。</p><ul><li>升级 lettuce 客户端，或使用 jedis 客户端</li></ul><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!-- redis --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.lettuce<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lettuce-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="高并发下缓存失效问题" tabindex="-1"><a class="header-anchor" href="#高并发下缓存失效问题" aria-hidden="true">#</a> 高并发下缓存失效问题</h3><h4 id="缓存穿透" tabindex="-1"><a class="header-anchor" href="#缓存穿透" aria-hidden="true">#</a> 缓存穿透</h4><p>缓存穿透是指查询一个一定不存在的数据，由于缓存是不命中，将去查询数据库，但是数据库也无此记录，我们没有将这次查询的 null 写入缓存，这将导致这个不存在的数据每次请求都要到存储层去查询，失去了缓存的意义。</p><p>在流量大时，可能 DB 就挂掉了，要是有人利用不存在的 key 频繁攻击我们的应用，这就是漏洞。</p><p><strong>解决方法</strong>：</p><ul><li><p>缓存空对象</p><p>优点：实现简单，维护方便</p><p>缺点：额外的内存消耗, 可能造成短期的不一致</p></li><li><p>布隆过滤</p><p>优点：内存占用较少，没有多余 key</p><p>缺点：实现复杂, 存在误判可能</p></li></ul><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202212020952912.png" alt="image-20221026154823594"></p><blockquote><p>布隆过滤器走的是哈希思想，只要是哈希思想，就可能存在哈希冲突</p></blockquote><h4 id="缓存雪崩" tabindex="-1"><a class="header-anchor" href="#缓存雪崩" aria-hidden="true">#</a> 缓存雪崩</h4><p>缓存雪崩是指在我们设置缓存时采用了相同的过期时间，导致缓存在某一时刻同时失效，请求全部转发到 DB，DB 瞬时压力过重雪崩。</p><p><strong>解决方法</strong>：原有的失效时间基础上增加一个随机值，比如 1-5 分钟随机，这样每一个缓存的过期时间的重复率就会降低，就很难引发集体失效的事件。</p><h4 id="缓存击穿" tabindex="-1"><a class="header-anchor" href="#缓存击穿" aria-hidden="true">#</a> 缓存击穿</h4><p>对于一些设置了过期时间的 key，如果这些 key 可能会在某些时间点被超高并发地访问，是一种非常“热点”的数据。</p><p>这个时候，需要考虑一个问题：如果这个 key 在大量请求同时进来前正好失效，那么所有对这个 key 的数据查询都落到 db，我们称为缓存击穿。</p><p><strong>解决方法</strong>：加锁。大量并发只让一个人去查，其他人等待，查到之后释放锁，其他人获取到锁，先查缓存，就会有数据，不用去查数据库。</p><h3 id="分布式锁" tabindex="-1"><a class="header-anchor" href="#分布式锁" aria-hidden="true">#</a> 分布式锁</h3><p>本地锁只能锁住当前服务的进程，每一个单独的服务都会有一个进程读取数据库，不能达到只读取依次数据库的效果，所以需要分布式锁。</p><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202212021017963.png" alt="image-20221202101712700"></p><h4 id="使用-redis-作为分布式锁" tabindex="-1"><a class="header-anchor" href="#使用-redis-作为分布式锁" aria-hidden="true">#</a> 使用 Redis 作为分布式锁</h4><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202212021618451.png" alt="image-20221202161527639"></p><p>redis 中有一个 SETNX 命令，该命令会向 redis 中保存一条数据，如果不存在则保存成功，存在则返回失败。</p><p>我们约定保存成功即为加锁成功，之后加锁成功的线程才能执行真正的业务操作。</p><p>添加锁, nx 是互斥, ex 是设置超时时间</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">set</span> lock thread1 nx ex <span class="token number">10</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>释放锁, 删除即可</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>del key
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>业务代码</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
* 从数据库查询并封装数据::分布式锁
*
* <span class="token keyword">@return</span>
*/</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catalogs2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCatalogJsonFromDbWithRedisLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//1、占分布式锁。去redis占坑 设置过期时间必须和加锁是同步的，保证原子性（避免死锁）</span>
    <span class="token class-name">String</span> uuid <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Boolean</span> lock <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token string">&quot;lock&quot;</span><span class="token punctuation">,</span> uuid<span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;获取分布式锁成功...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catalogs2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> dataFromDb <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//加锁成功...执行业务</span>
            dataFromDb <span class="token operator">=</span> <span class="token function">getCatalogJsonFromDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// lua 脚本解锁</span>
            <span class="token class-name">String</span> script <span class="token operator">=</span> <span class="token string">&quot;if redis.call(&#39;get&#39;, KEYS[1]) == ARGV[1] then return redis.call(&#39;del&#39;, KEYS[1]) else return 0 end&quot;</span><span class="token punctuation">;</span>
            <span class="token comment">// 删除锁</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>script<span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token string">&quot;lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//先去redis查询下保证当前的锁是自己的</span>
        <span class="token comment">//获取值对比，对比成功删除=原子性 lua脚本解锁</span>
        <span class="token comment">// String lockValue = stringRedisTemplate.opsForValue().get(&quot;lock&quot;);</span>
        <span class="token comment">// if (uuid.equals(lockValue)) {</span>
        <span class="token comment">//     //删除我自己的锁</span>
        <span class="token comment">//     stringRedisTemplate.delete(&quot;lock&quot;);</span>
        <span class="token comment">// }</span>
        <span class="token keyword">return</span> dataFromDb<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;获取分布式锁失败...等待重试...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//加锁失败...重试机制</span>
        <span class="token comment">//休眠一百毫秒</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">getCatalogJsonFromDbWithRedisLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//自旋的方式</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="redisson-作为分布式锁" tabindex="-1"><a class="header-anchor" href="#redisson-作为分布式锁" aria-hidden="true">#</a> Redisson 作为分布式锁</h4><p><img src="https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202212021513370.png" alt="image-20221030170143176"></p><p>相关依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.11.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置 redisson</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyRedissonConfig</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 所有对 Redisson 的使用都是通过 RedissonClient
     *
     * <span class="token keyword">@return</span>
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">IOException</span></span>
     */</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>destroyMethod <span class="token operator">=</span> <span class="token string">&quot;shutdown&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RedissonClient</span> <span class="token function">redisson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1、创建配置</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Redis url should start with redis:// or rediss://</span>
        config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">&quot;redis://192.168.137.110:6379&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2、根据 Config 创建出 RedissonClient 实例</span>
        <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 1. 获取一把锁</span>
<span class="token class-name">Rlock</span> lock <span class="token operator">=</span> redisson<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;my-lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 2. 加锁, 阻塞式等待</span>
lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;加锁成功，执行业务...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
	<span class="token comment">// 3. 解锁 假设解锁代码没有运行，Redisson 会出现死锁吗？（不会）</span>
    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>锁的自动续期，如果业务时间很长，运行期间自动给锁续期 30 s，不用担心业务时间过长，锁自动过期被删掉；</li><li>加锁的业务只要运行完成，就不会给当前锁续期，即使不手动续期，默认也会在 30 s 后解锁；</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 缓存里的数据如何和数据库的数据保持一致？？
 * 缓存数据一致性
 * 1)、双写模式
 * 2)、失效模式
 *
 * <span class="token keyword">@return</span>
 */</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catalogs2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCatalogJsonFromDbWithRedissonLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//1、占分布式锁。去redis占坑</span>
    <span class="token comment">//（锁的粒度，越细越快:具体缓存的是某个数据，11号商品） product-11-lock</span>
    <span class="token comment">//RLock catalogJsonLock = redissonClient.getLock(&quot;catalogJson-lock&quot;);</span>
    <span class="token comment">//创建读锁</span>
    <span class="token class-name">RReadWriteLock</span> readWriteLock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getReadWriteLock</span><span class="token punctuation">(</span><span class="token string">&quot;catalogJson-lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">RLock</span> rLock <span class="token operator">=</span> readWriteLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catalogs2Vo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> dataFromDb <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        rLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//加锁成功...执行业务</span>
        dataFromDb <span class="token operator">=</span> <span class="token function">getCatalogJsonFromDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        rLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> dataFromDb<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="springcache" tabindex="-1"><a class="header-anchor" href="#springcache" aria-hidden="true">#</a> SpringCache</h3><p>依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-cache<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>依赖导入会进行一些默认配置</p><ul><li>CacheAutoConfiguration 会导入 RedisCacheConfiguration;</li><li>会自动装配缓存管理器 RedisCacheManager;</li></ul><p>配置文件部分配置</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment">#使用 redis 缓存</span>
<span class="token key attr-name">spring.cache.type</span><span class="token punctuation">=</span><span class="token value attr-value">redis</span>

<span class="token comment">#spring.cache.cache-names=qq,手动指定缓存名字后会关闭自动创建(动态创建)</span>
<span class="token key attr-name">spring.cache.redis.time-to-live</span><span class="token punctuation">=</span><span class="token value attr-value">3600000</span>

<span class="token comment">#如果指定了前缀就用我们指定的前缀，如果没有就默认使用缓存的名字作为前缀</span>
<span class="token comment">#spring.cache.redis.key-prefix=CACHE_</span>
<span class="token key attr-name">spring.cache.redis.use-key-prefix</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>

<span class="token comment">#是否缓存空值，防止缓存穿透</span>
<span class="token key attr-name">spring.cache.redis.cache-null-values</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="常用注解" tabindex="-1"><a class="header-anchor" href="#常用注解" aria-hidden="true">#</a> 常用注解</h4><ul><li>@Cacheable: 触发将数据保存到缓存的操作；</li><li>@CacheEvict: 触发将数据从缓存删除的操作；</li><li>@CachePut: 不影响方法执行更新缓存；</li><li>@Caching: 组合以上多个操作；</li><li>@CacheConfig: 在类级别共享缓存的相同配置；</li></ul><p>在启动类或者配置类加上 <code>@EnableCaching</code> 注解即可开启使用缓存。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableCaching</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CachingApplication</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">CachingApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="cacheable" tabindex="-1"><a class="header-anchor" href="#cacheable" aria-hidden="true">#</a> @Cacheable</h5><p><code>@Cacheable</code> 注解会先查询是否已经有缓存，有会使用缓存，没有则会执行方法并缓存</p><p>默认行为:</p><ul><li>如果缓存中有，方法不再调用</li><li>默认生成的key: <code>缓存的名字::SimpleKey::[]</code></li><li>缓存的value值默认使用 jdk 序列化机制，将序列化的数据存到 redis 中</li><li>默认时间是 -1</li></ul><p>自定义操作：key的生成</p><ul><li>指定生成缓存的key：key属性指定，接收一个 SpEl</li><li>指定缓存的数据的存活时间: 配置文件中修改存活时间 ttl</li><li>将数据保存为json格式: 自定义配置类 MyCacheManager</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Cacheable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span>key <span class="token operator">=</span> <span class="token string">&quot;#userId&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">UserInfo</span> <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//从数据库查询</span>
    <span class="token class-name">UserInfo</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span><span class="token string">&quot;ceshi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> user<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>此处的 <code>value</code> 是必需的，它指定了你的缓存存放的地方</p></blockquote><p>SpEl 简单使用</p><p>常量: key = &quot;`queryById`&quot;</p><p>变量:</p><table><thead><tr><th style="text-align:left;">Name</th><th style="text-align:left;">Location</th><th style="text-align:left;">Description</th><th style="text-align:left;">Example</th></tr></thead><tbody><tr><td style="text-align:left;"><code>methodName</code></td><td style="text-align:left;">Root object</td><td style="text-align:left;">The name of the method being invoked</td><td style="text-align:left;"><code>#root.methodName</code></td></tr><tr><td style="text-align:left;"><code>method</code></td><td style="text-align:left;">Root object</td><td style="text-align:left;">The method being invoked</td><td style="text-align:left;"><code>#root.method.name</code></td></tr><tr><td style="text-align:left;"><code>target</code></td><td style="text-align:left;">Root object</td><td style="text-align:left;">The target object being invoked</td><td style="text-align:left;"><code>#root.target</code></td></tr><tr><td style="text-align:left;"><code>targetClass</code></td><td style="text-align:left;">Root object</td><td style="text-align:left;">The class of the target being invoked</td><td style="text-align:left;"><code>#root.targetClass</code></td></tr><tr><td style="text-align:left;"><code>args</code></td><td style="text-align:left;">Root object</td><td style="text-align:left;">The arguments (as array) used for invoking the target</td><td style="text-align:left;"><code>#root.args[0]</code></td></tr><tr><td style="text-align:left;"><code>caches</code></td><td style="text-align:left;">Root object</td><td style="text-align:left;">Collection of caches against which the current method is run</td><td style="text-align:left;"><code>#root.caches[0].name</code></td></tr><tr><td style="text-align:left;">Argument name</td><td style="text-align:left;">Evaluation context</td><td style="text-align:left;">Name of any of the method arguments. If the names are not available (perhaps due to having no debug information), the argument names are also available under the <code>#a&lt;#arg&gt;</code> where <code>#arg</code> stands for the argument index (starting from <code>0</code>).</td><td style="text-align:left;"><code>#iban</code> or <code>#a0</code> (you can also use <code>#p0</code> or <code>#p&lt;#arg&gt;</code> notation as an alias).</td></tr><tr><td style="text-align:left;"><code>result</code></td><td style="text-align:left;">Evaluation context</td><td style="text-align:left;">The result of the method call (the value to be cached). Only available in <code>unless</code> expressions, <code>cache put</code> expressions (to compute the <code>key</code>), or <code>cache evict</code> expressions (when <code>beforeInvocation</code> is <code>false</code>). For supported wrappers (such as <code>Optional</code>), <code>#result</code> refers to the actual object, not the wrapper.</td><td style="text-align:left;"><code>#result</code></td></tr></tbody></table><h6 id="自定义序列化" tabindex="-1"><a class="header-anchor" href="#自定义序列化" aria-hidden="true">#</a> 自定义序列化</h6><p>原理:</p><p>CacheAutoConfiguration -&gt; RedisCacheConfiguration -&gt; 自动配置 RedisCacheManager -&gt; 初始化所有的缓存 -&gt; 每个缓存决定使用什么配置 -&gt; 判断RedisCacheConfiguration == null 为 null 就用系统默认的, 不为 null 就用自己写的 -&gt; 修改缓存配置只要给容器放一个 RedisCacheConfiguration 即可</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token class-name">CacheProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyCacheConfig</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * 配置文件的配置没有用上
     * 1. 原来和配置文件绑定的配置类为：@ConfigurationProperties(prefix = &quot;spring.cache&quot;)
     * public class CacheProperties
     * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
     * 2. 要让他生效，要加上 @EnableConfigurationProperties(CacheProperties.class)
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisCacheConfiguration</span> <span class="token function">redisCacheConfiguration</span><span class="token punctuation">(</span><span class="token class-name">CacheProperties</span> cacheProperties<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">RedisCacheConfiguration</span> config <span class="token operator">=</span> <span class="token class-name">RedisCacheConfiguration</span><span class="token punctuation">.</span><span class="token function">defaultCacheConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// config = config.entryTtl();</span>
        config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">serializeKeysWith</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializationContext<span class="token punctuation">.</span>SerializationPair</span><span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">serializeValuesWith</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializationContext<span class="token punctuation">.</span>SerializationPair</span><span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GenericJackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CacheProperties<span class="token punctuation">.</span>Redis</span> redisProperties <span class="token operator">=</span> cacheProperties<span class="token punctuation">.</span><span class="token function">getRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将配置文件中所有的配置都生效</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getTimeToLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">entryTtl</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getTimeToLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">prefixKeysWith</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>redisProperties<span class="token punctuation">.</span><span class="token function">isCacheNullValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">disableCachingNullValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>redisProperties<span class="token punctuation">.</span><span class="token function">isUseKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">disableKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> config<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="cacheevict" tabindex="-1"><a class="header-anchor" href="#cacheevict" aria-hidden="true">#</a> @CacheEvict</h5><p><code>@CacheEvict</code> 触发将数据从缓存删除的操作</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 根据id修改</span>
<span class="token annotation punctuation">@CacheEvict</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token string">&quot;#userId&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//修改用户</span>
    <span class="token class-name">UserInfo</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span><span class="token string">&quot;itcast&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 清除user分区下的全部缓存</span>
<span class="token annotation punctuation">@CacheEvict</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> allEntries <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//修改用户</span>
    <span class="token class-name">UserInfo</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span><span class="token string">&quot;itcast&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="caching" tabindex="-1"><a class="header-anchor" href="#caching" aria-hidden="true">#</a> @Caching</h5><p><code>@Caching</code> 组合以上多个操作</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Caching</span><span class="token punctuation">(</span>evict <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@CacheEvict</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token string">&quot;`userId`&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token annotation punctuation">@CacheEvict</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token string">&quot;`userName`&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//修改用户</span>
    <span class="token class-name">UserInfo</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span><span class="token string">&quot;itcast&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="cacheput" tabindex="-1"><a class="header-anchor" href="#cacheput" aria-hidden="true">#</a> @CachePut</h5><p><code>@CachePut</code> 不影响方法执行更新缓存</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@CachePut</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//修改用户</span>
    <span class="token class-name">UserInfo</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span><span class="token string">&quot;itcast&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><strong>官方强烈不推荐将 <code>@Cacheable</code> 和 <code>@CachePut</code> 注解到同一个方法</strong></p></blockquote><h5 id="cacheconfig" tabindex="-1"><a class="header-anchor" href="#cacheconfig" aria-hidden="true">#</a> @CacheConfig</h5><p>一个类中可能会有多个缓存操作，而这些缓存操作可能是重复的。这个时候可以使用 <code>@CacheConfig</code></p><p>在类头上加了注解等同于每个方法上的缓存注解都加了 <code>cacherName</code> 或者 <code>value</code> 指定的组件并且这个组件来自 <code>@CacheConfig</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@CacheConfig</span><span class="token punctuation">(</span><span class="token string">&quot;books&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BookRepositoryImpl</span> <span class="token keyword">implements</span> <span class="token class-name">BookRepository</span> <span class="token punctuation">{</span>
 
    <span class="token annotation punctuation">@Cacheable</span>
    <span class="token keyword">public</span> <span class="token class-name">Book</span> <span class="token function">findBook</span><span class="token punctuation">(</span><span class="token class-name">ISBN</span> isbn<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="不足之处" tabindex="-1"><a class="header-anchor" href="#不足之处" aria-hidden="true">#</a> 不足之处</h4><p>读模式</p><ul><li>缓存穿透：查询一个null数据。解决方案：缓存空数据</li><li>缓存击穿：大量并发进来同时查询一个正好过期的数据。解决方案：加锁 ? 默认是无加锁的;使用 <code>sync = true</code> 来解决击穿问题</li><li>缓存雪崩：大量的key同时过期。解决：加随机时间。加上过期时间</li></ul><p>写模式（缓存与数据库一致）</p><ul><li>读写加锁。</li><li>引入Canal,感知到MySQL的更新去更新Redis</li><li>读多写多，直接去数据库查询就行</li></ul><p>总结：</p><ul><li>常规数据（读多写少，即时性，一致性要求不高的数据，完全可以使用Spring-Cache）：写模式(只要缓存的数据有过期时间就足够了)</li><li>特殊数据：特殊设计</li></ul><h3 id="检索服务" tabindex="-1"><a class="header-anchor" href="#检索服务" aria-hidden="true">#</a> 检索服务</h3><p>依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!-- 模板引擎 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-thymeleaf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>hosts</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">192.168</span>.163.131		search.gulimall.com
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>gulimall.conf</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>server <span class="token punctuation">{</span>
    listen       <span class="token number">80</span><span class="token punctuation">;</span>
    server_name  gulimall.com *.gulimall.com<span class="token punctuation">;</span>
		<span class="token punctuation">..</span>.
 <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker</span> restart nginx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>gateway</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> mall_search_route
  <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//mall<span class="token punctuation">-</span>search
  <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> Host=search.gulimall.com
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="异步与线程池" tabindex="-1"><a class="header-anchor" href="#异步与线程池" aria-hidden="true">#</a> 异步与线程池</h2></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/SurplusFate/SurplusFate.github.io/edit/main/src/docs/项目笔记/谷粒商城.md" rel="noopener noreferrer" target="_blank" aria-label="编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item update-time"><span class="label">上次编辑于: </span><!----></div><!----></footer><nav class="page-nav"><a href="/docs/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/%E8%87%AA%E5%AE%9A%E4%B9%89%E8%87%AA%E5%8A%A8%E5%A1%AB%E5%85%85.html" class="nav-link prev" aria-label="自定义自动填充"><div class="hint"><span class="arrow left"></span>上一页</div><div class="link"><!---->自定义自动填充</div></a><!----></nav><!----><!----><!--]--></main><!--]--><!----><!--]--></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app.03ab472a.js" defer></script>
  </body>
</html>
