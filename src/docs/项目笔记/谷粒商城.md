# 谷粒商城

## 项目概览

### 项目架构图

![image.png](https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211171222389.png)

### 技术栈

SpringBoot, SpringCloud, Nacos, OpenFeign, Gateway, Docker, RabbitMQ, Elasticsearch, Sentinel, K8S,...

## 环境搭建

虚拟机, docker, docker 安装 mysql, docker 安装 redis, git

初始化数据库:

[pms_catelog.sql](环境搭建/pms_catelog.sql)

[gulimall_oms.sql](环境搭建/gulimall_oms.sql)

[gulimall_pms.sql](环境搭建/gulimall_pms.sql)

[gulimall_sms.sql](环境搭建/gulimall_sms.sql)

[gulimall_ums.sql](环境搭建/gulimall_ums.sql)

[gulimall_wms.sql](环境搭建/gulimall_wms.sql)

## 项目搭建

## 快速开发

人人开源或其他后台管理系统均可

人人开源后端:

[人人开源/renren-security](https://gitee.com/renrenio/renren-security)

前端:

[人人开源/renren-ui](https://gitee.com/renrenio/renren-ui)

现在直接使用人人开源后端的项目作为主模块, 避免频繁重复的修改无意义的代码, 大致结构:

![image-20221117122831131](https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211171228187.png)

红色部分为项目自带模块, 代码生成器也集成进来了

### 配置修改

#### 后端

修改人人开源项目的 springboot 版本, 降级为 2.6.x 否则无法适配 springcloud 和 springcloud alibaba

![image.png](https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211171230387.png)

**阿里官方概述:**

如果项目中需要使用 Spring Cloud Alibaba 2021.0.1.0 版本，请在项目中添加如下依赖：

```xml
<dependencyManagement>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-dependencies</artifactId>
        <version>2.6.3</version>
        <type>pom</type>
        <scope>import</scope>
    </dependency>
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-dependencies</artifactId>
        <version>2021.0.1</version>
        <type>pom</type>
        <scope>import</scope>
    </dependency>
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-alibaba-dependencies</artifactId>
        <version>2021.0.1.0</version>
        <type>pom</type>
        <scope>import</scope>
    </dependency>
</dependencyManagement>
```

项目中可以将后端 springboot 修改为:

```xml
<parent>
   <groupId>org.springframework.boot</groupId>
   <artifactId>spring-boot-starter-parent</artifactId>
   <version>2.6.3</version>
       <relativePath/>
</parent>
```

添加对应的 springcloud 和 springcloud alibaba

```xml
<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-dependencies</artifactId>
            <version>2021.0.5</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-alibaba-dependencies</artifactId>
            <version>2021.0.4.0</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
```

##### 调整依赖(可选)

将部分依赖和工具类抽取到 renren-common 下, **不是必须**, 可按照自己的喜好来

调整后会出现较多的依赖报错, 在 renren-common 中重新引入即可

> **<font color=red>依赖迁移的时候千万不要引错包, 有的依赖有 springboot 版本和 非 springboot 版本, 引入的版本不对不会有错误提示, 在运行时会提示无法自动装配</font>**
>
> **<font color=red>抽取工具类的时候要看看配置文件有没有配置也需要抽出来, 否则其他模块启动的时候可能会报一些不好定位错误的异常</font>**

例如提取 `ExcelUtils.java` , 同时需要将相关依赖提取出来

通过代码生成器生成的代码有部分会使用到 renren-admin 下的包依赖, 可以将这部分依赖也提取出来, 例如 `shiro` 相关的包

调整 renren-security 的依赖, 使父模块只做版本管理, 不引入依赖, 避免子模块引入多余模块

将所有 `dependencies` 中的依赖都移入 renren-common

![image.png](https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211171222547.png)

使用 renren-common 做统一依赖管理

![image-20221117123820537](https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211171245921.png)

#### 前端

修改 node 版本为 14, 官方要求为 12.x 14.x

![image.png](https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211171222504.png)

推荐使用 nvm, 方便管理 node 版本

### 代码生成器

> 生成的代码是前后端配套的, 可以直接使用

![image-20221118150002822](https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211181517360.png)

![image-20221118150400732](https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211181517035.png)

#### 后端代码调整

> 后端生成的代码实体类(`io.renren.modules.*.entity`)中不会标注 `@TableId` 要自己手动补充, 否则后续增删改查可能会出现 `Invalid bound statement (not found)`
>
> 官方说明: <https://baomidou.com/pages/f84a74/#%E5%87%BA%E7%8E%B0-invalid-bound-statement-not-found-%E5%BC%82%E5%B8%B8>

#### 前端代码调整

前端代码对每条数据的增删改查有个固定的执行顺序, 例如: `category.vue` -> `view-module.js` -> `category-add-or-update.vue`, 所有增删改查都会经过 `view-module.js`

前端会通过主键 `id` 来获取需要修改的具体对象, 其中中间层 `view-module.js` 是接收固定的属性 `id`

![image-20221122141715001](https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211221417251.png)

如果我们的数据库主键字段名不是 `id` 就需要手动修改:

将 `category.vue` 中的 `scope.row.id` 改成 `scope.row.catId`

![image-20221122142010592](https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211221420633.png)

将 `category-add-or-update.vue` 中 `init()`, 和 `getInfo()` 方法中的 `catId` 修改为 `id`:

![image-20221122142835329](https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211221428401.png)

或者在获取 `id` 时进行一次赋值:

![image-20221122143319940](https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211221433981.png)

### 踩坑

#### Docker 容器突然连接不上

重启 Linux 无效, 重启 Docker 后解决

可能原因:

1. 宿主机的 IP_FORWARD 功能失效

2. 端口没开放

查看 IP_FORWARD 功能有没有启用(1 表示已经启用, 0 表示未启用)

```sh
sysctl net.ipv4.ip_forward
```

这里有可能显示是 1 但实际是 0; 将状态重置:

```sh
systemctl restart network.service
```

手动写入:

```sh
echo 'net.ipv4.ip_forward = 1' >> /usr/lib/sysctl.d/50-default.conf
```

加载配置文件:

```sh
sysctl -p /usr/lib/sysctl.d/50-default.conf
```

CentOS 7 下的一些其他相关命令:

查看 Docker 容器:

```sh
docker ps -a
```

有参数 `-a` 表示查看全部容器, 无参数表示查看正在运行的容器

查看开放的端口:

```sh
firewall-cmd --list-ports
```

查看开放的服务:

```sh
firewall-cmd --list-services
```

查看防火墙状态:

```sh
systemctl status firewalld
```

关闭防火墙:

```sh
systemctl stop firewalld
```

开启防火墙:

```sh
systemctl start firewalld
```

打开指定端口:

```sh
firewall-cmd --permanent --add-port=端口号/协议
```

例如打开 8080 端口:

```sh
firewall-cmd --permanent --add-port=8080/tcp
```

关闭端口:

```sh
firewall-cmd --permanent --remove-port=端口号/协议
```

重新载入生效:

```sh
firewall-cmd --reload
```

查询端口是否开放:

```sh
firewall-cmd --query-port=端口号/协议
```

#### <font color =red>Docker 中的数据丢失!</font>

Docker 中的 MySQL 因为一次异常停止, 在重启后所有数据全部丢失, 且查询 root 权限显示正常, 实际连建表权限都没有!

> **容器一定要挂载数据卷!**

#### Nacos2 连接不上/端口未开放

先是连接不上 nacos, 需要补充依赖:

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-bootstrap</artifactId>
    <version>3.0.3</version>
</dependency>
```

尝试连接 nacos 的时候报了一个关于 9848 端口的错误, nacos2 还需要开放该端口:

```sh
firewall-cmd --permanent --add-port=9848/tcp
```

重新载入生效:

```sh
firewall-cmd --reload
```

如果是把 nacos 部署在 docker 中, 则需要重新创建容器并设置端口, 可以使用 idea 连接 docker, 但延迟较大

![image.png](https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211171222224.png)

![image.png](https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211171232265.png)

删除 docker 容器命令:

```sh
docker rm -f nacos
```

创建并运行 nacos 容器命令参考:

```sh
docker run \
--name nacos \
-e MODE=standalone \
-e JVM_XMS=512m \
-e JVM_XMX=512m \
-p 8848:8848 \
-p 9848:9848 \
-d nacos/nacos-server:2.0.2
```

详细配置列表:

[github.com](https://github.com/nacos-group/nacos-docker/blob/master/README_ZH.md#%E5%B1%9E%E6%80%A7%E9%85%8D%E7%BD%AE%E5%88%97%E8%A1%A8)

重启 docker 命令:

```sh
Systemctl restart docker
```

idea 中显示 docker 状态有较大延迟, 没反应可尝试重新连接 docker

#### idea 连不上 Docker 中的 MySQL5.7

![image-20221119191826977](https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211191918058.png)

需要添加配置

```sh
TLSv1,TLSv1.1,TLSv1.2,TLSv1.3
```

![image-20221119191758437](https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211191918688.png)

> **记得点应用！**

## 商品服务

### 递归查询父子节点

> 不要删除或改动自动生成的代码!项目默认是以表格形式展示

数据库父类的 catId 就是子类的 parentId;

![image-20221118100041911](https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211181000192.png)

获取所有数据, 筛选出最高级父类;

```java
List<CategoryEntity> tree = categoryService.getTree();
        List<CategoryDTO> dtoTree = new ArrayList<>();
        // 全部数据
        tree.forEach(t -> dtoTree.add(BeanUtil.copyProperties(t, CategoryDTO.class)));
```

通过父类 id 和子类 parentid 进行关联;

```java
// 1. 找到所有的一级分类
List<CategoryDTO> leave1 =
        dtoTree.stream()
                .filter(r -> r.getParentCid() == 0)
                // 2. 递归获取所有子菜单
                .map(
                        r -> {
                            r.setChildren(getChildren(r, dtoTree));
                            return r;
                        }
                )
                // 3. 排序 踩坑 Integer 包装类赋值为 0 的情况下会自动转成 null
                .sorted(Comparator.comparingInt(r -> (r.getSort() == null ? 0 : 1)))
                .collect(Collectors.toList());
```

利用递归进行多级查询

```java
private List<CategoryDTO> getChildren(CategoryDTO parent, List<CategoryDTO> allData) {
    return
            allData.stream()
                    .filter(c -> c.getParentCid().equals(parent.getCatId()))
                    .map(p -> {
                        p.setChildren(getChildren(p, allData));
                        return p;
                    })
                    .sorted(Comparator.comparingInt(r -> (r.getSort() == null ? 0 : 1)))
                    .collect(Collectors.toList());
}
```

> 自动生成的代码没有遵循数据库设计规范(缺少逻辑删除, 创建时间, 更新时间这三个字段), 如果希望自动生成的的代码正常运行需要手动补加
>
> 如果后端依赖或者配置文件调整不当, 最终会导致项目默认的分页功能失效, 前端会一页展示所有数据

### 逻辑删除

除了按照 [MyBatis-Plus](https://baomidou.com/pages/6b03c5/#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95) 官方文档的配置配好以外, 别忘记补充字段

![image-20221122091208793](https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211220913005.png)

### Gateway 路由配置

#### 负载均衡/错误 503

单独在 gateway 启用负载均衡需要添加 loadbalancer 依赖, 否则会报 **503 错误**:

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-loadbalancer</artifactId>
</dependency>
```

![image-20221118162622309](https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211181626349.png)

#### 跨域出现 origin 重复

![image-20221118162924623](https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211181629661.png)

![image-20221118162951157](https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211181629239.png)

因为人人开源配置了默认的跨域

![image-20221118171602184](https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211181716930.png)

可以将默认跨域注释掉或者使用 gateway 的配置解决

> 在官方文档检索 `CORS` 可查找到相关信息

<https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-deduperesponseheader-gatewayfilter-factory>

![image-20221118162342771](https://gcore.jsdelivr.net/gh/SurplusFate/guide_img@main/img/202211181623856.png)
